---
title: "**Evolution of reproduction, survival, and body size in response to changing temperatures**"
author: Pottier et al.
date: "latest update: `r format(Sys.time(), '%d %B %Y')`"
output: 
  rmdformats::downcute:
    code_folding: show
    code_download: true
    toc_depth: 6
    toc_float:
      collapsed: false
    lightbox: true
    thumbnails: false
    downcute_theme: "chaos"
    code_overflow: wrap
editor_options: 
  chunk_output_type: console
---


<style type="text/css">

/* Adjust the title area */
.title {
    max-width: 140% !important;
    width: 140% !important;
}

/* Position the TOC on the left */
#toc {
    position: fixed !important;
    top: 0 !important;
    left: 100px !important;
    right: -200px !important;
    overflow-y: auto !important;
    padding-top: 50px !important;
    z-index: 1000 !important; 
}

/* Position the theme switch button to the bottom left */
.dark-theme-toggler {
    position: fixed !important;
    bottom: -150px !important; 
    left: 100px !important;  
    z-index: 500 !important; 
}

/* Adjust the main content area */
.page-content {
    max-width: 140% !important; 
    width: 140% !important;
}

/* Adjust the width of code blocks */
pre, code, pre code {
    max-width: 100% !important;
    width: 100% !important;
}

/* The table of contents */
#toc ul.nav li ul li {
    display: none;
    max-height: none;
}

#toc ul.nav li.active ul li {
    display: block;
    max-height: none;
}

#toc ul.nav li ul li ul li {
    max-height: none;
    display: none !important;
}

#toc ul.nav li ul li.active ul li {
    max-height: none;
    display: block !important;
}

/* Header colors */
h1, h2, h3, h4, h5, h6 {
    color: deeppink !important;
}

/* Adjust font sizes in the TOC */

/* Top-level items */
#toc ul.nav > li > a {
    font-size: 25px !important;
}

/* Second-level items */
#toc ul.nav li ul li > a {
    font-size: 20px !important;
}

/* Third-level items */
#toc ul.nav li ul li ul li > a {
    font-size: 18px !important;
}

</style>

```{r setup, include = FALSE}
# knitr setting
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE, 
  tidy = TRUE,
  cache = TRUE,
  echo=TRUE
)
```

# **Introduction** 

This Rmarkdown file summarises all code used to process, analyse, and visualise the data.
However, note that the code for all statistical models requires extensive computational power, and ran on the computational cluster Katana supported by Research Technology Services at the University of New South Wales, Sydney (https://research.unsw.edu.au/katana). 
Please see the folder /R to find the files that were used to run the statistical models separately and the /pbs folder to find the resources needed to run each model.
If you have any questions or find mistakes in the code presented below, please contact Patrice Pottier at p.pottier@unsw.edu.au 


# **Load packages** 
```{r}
pacman::p_load(tidyverse,
               purrr,
               ape,
               rotl,
               brms,
               orchaRd,
               metafor,
               emmeans,
               tidybayes,
               ggbeeswarm,
               kableExtra,
               ggtree,
               ggtreeExtra)
set.seed(234)
```

# **Data wrangling** 

## **Load raw data** 
```{r}
# Load raw extracted data
raw_data <- read_csv("data_extraction/all_extracted_data.csv")
raw_data <- as.data.frame(raw_data)

# Rename body size values
raw_data$trait_type[raw_data$trait_type=="body size"] <- "body_size"
raw_data <- rename(raw_data, `peer_reviewed` = 'peer-reviewed')

# Calculate the temperature difference between selection temperatures (in absolute values because it is modeled independently for warmer and colder lines)
raw_data <- raw_data %>% mutate(select_temp_diff = abs(treatment_temp - control_temp))

# Calculate the temperature difference between assay and control temperature
raw_data <- raw_data %>% mutate(assay_temp_diff = assay_temp - control_temp)
```

## **Convert confidence intervals to SE, and SE to SD**

To use effective sample size properly, we need to first back-convert estimates reported as SE to SD. 
```{r}
processed_data <- raw_data %>% mutate(error_control = ifelse(error_type == "ci", error_control/1.96, error_control),
                                error_treatment = ifelse(error_type == "ci", error_treatment/1.96, error_treatment)) %>% 
                         mutate(error_type = ifelse(error_type == "ci", "se", error_type))

processed_data <- raw_data %>% mutate(sd_control = ifelse(error_type == "se", error_control*sqrt(n_used_control), error_control),
                              sd_treatment = ifelse(error_type == "se", error_treatment*sqrt(n_used_treatment), error_treatment))

processed_data <- processed_data %>% mutate(sd_control = ifelse(sd_control == 0, NA, sd_control), 
                                           sd_treatment = ifelse(sd_treatment == 0, NA, sd_treatment)) # Replace values of 0 for the error by NA, as these result from a lack of sampling. 
```

## **Calculate effective sample sizes** 

Because the true level of replication in experimental evolution studies is the number of replicate selection lines, 
we calculated effective sample sizes to account for pseudo-replication.
Effective sample sizes were calculated from formulas in Rutkowska et al. 2013. https://doi.org/10.1111/jeb.12282 
ICC was taken as 0.5, which is conservative. It assumes that life history traits are repeatable between selection lines, so the effective sample size is closer to the number of lines than it is to the total number of individuals tested.
When the number of animals was not available, the sample size was taken as the number of replicates.
```{r}
# Calculate effective sample sizes
processed_data <- processed_data %>% 
  mutate(eff_n_control= ifelse(is.na(n_animals_control)==TRUE, 
                               n_control, 
                               n_animals_control / (1 + 0.5*((n_animals_control/n_control)-1))),
         
         eff_n_treatment= ifelse(is.na(n_animals_treatment)==TRUE, 
                               n_treatment, 
                               n_animals_treatment / (1 + 0.5*((n_animals_treatment/n_treatment)-1))))
```


## **Calculate effect sizes** 

### **Custom functions** 

Here, we use custom functions to calculate the average coefficient of variation and impute missing standard deviations. 
See Nakagawa et al. 2023 (Methods in Ecology and Evolution)
```{r}
cv_avg <- function(x, sd, n, group, data, label = NULL, sub_b = TRUE, cv2=FALSE){

  # Check if the name is specified or not. If not, then assign it the name of the mean, x, variable input in the function. https://stackoverflow.com/questions/60644445/converting-tidyeval-arguments-to-string
  if(is.null(label)){
    label <- purrr::map_chr(enquos(x), rlang::as_label)
  }

  # Calculate between study CV. Take weighted mean CV within study, and then take a weighted mean across studies of the within study CV. Weighted based on sample size and pooled sample size.
  b_grp_cv_data <- data                                             %>%
    dplyr::group_by({{group}})                            %>%
    dplyr::mutate(   w_CV2 = weighted_CV({{sd}}, {{x}}, {{n}}, cv2=cv2),
                     n_mean = mean({{n}}, na.rm = TRUE))   %>%
    dplyr::ungroup(.)                                     %>%
    dplyr::mutate(b_CV2 = weighted.mean(w_CV2, n_mean, na.rm = TRUE), .keep = "used")

  # Make sure that label of the calculated columns is distinct from any other columns
  names(b_grp_cv_data) <- paste0(names(b_grp_cv_data), "_", label)

  # Append these calculated columns back to the original data and return the full dataset.
  if(sub_b){
    b_grp_cv_data <- b_grp_cv_data %>% dplyr::select(grep("b_", names(b_grp_cv_data)))
    dat_new <- cbind(data, b_grp_cv_data)
  } else {
    dat_new <- cbind(data, b_grp_cv_data)
  }

  return(data.frame(dat_new))
}

# Helper function
weighted_CV <- function(sd, x, n, cv2=FALSE){
  if(cv2){
    weighted.mean(na_if((sd / x)^2, Inf), n, na.rm = TRUE)
  }else{
    weighted.mean(na_if((sd / x), Inf), n, na.rm = TRUE)^2
  }
}
```


### **Impute missing standard deviations and calculate effect sizes**

Different formulas were used for independent and dependent samples (see methods).
```{r}
# Calculate average standard deviations
processed_data <- cv_avg(x=mean_control, sd = sd_control, n=eff_n_control, group = ref, label = "control", data = processed_data) # Control
processed_data <- cv_avg(x=mean_treatment, sd = sd_treatment, n=eff_n_treatment, group = ref, label = "treatment", data = processed_data) # Treatment

# Multiply the coefficient of variation by the mean to get SD
processed_data <- processed_data %>% mutate(sd_control = ifelse(is.na(sd_control)==TRUE,
                                                                b_CV2_control*mean_control,
                                                                sd_control),
                                            sd_treatment = ifelse(is.na(sd_treatment)==TRUE,
                                                                b_CV2_treatment*mean_treatment,
                                                                sd_treatment))

# Add a column to identify observations sharing the same cohort IDs
processed_data <- processed_data %>%
  group_by(cohort_ID) %>%
  mutate(n_cohort = n()) %>%
  ungroup()

# Calculate effect sizes for independent and dependent (traits measured on the same animals) samples.
processed_data <- processed_data %>% mutate(
  # Log response ratio (lnRR)
  lnRR = log(mean_treatment/mean_control) + 
                (0.5 * ((sd_treatment^2/(eff_n_treatment*mean_treatment^2)) -    
                       (sd_control^2/(eff_n_control*mean_control^2)))), # Formula 4 in Senior et al. 2020
    
  # Sampling variance of lnRR
  var_lnRR = ifelse(n_cohort == 1, # If samples are independent
    
             (sd_control^2/(eff_n_control*mean_control^2)) + 
             (sd_control^4/(2*eff_n_control^2*mean_control^4)) + 
             (sd_treatment^2/(eff_n_treatment*mean_treatment^2)) +
             (sd_treatment^4/(2*eff_n_treatment^2*mean_treatment^4)), # Formula 14 in Senior et al. 2020
  
             (sd_control^2/(eff_n_control*mean_control^2)) +  # else use this formula if samples are dependent
             (sd_treatment^2/(eff_n_treatment*mean_treatment^2)) +
             (sd_control^4/(2*eff_n_control^2*mean_control^4)) + 
             (sd_treatment^4/(2*eff_n_treatment^2*mean_treatment^4)) - 
             (0.5 * ((2*sd_control*sd_treatment)/(eff_n_control*mean_control*mean_treatment))) + 
             (0.5^2 * ((sd_control^2*sd_treatment^2*(mean_control^4+mean_treatment^4))/(2*eff_n_control^2*mean_control^4*mean_treatment^4))) # Formula 19 in Senior et al. 2020
  ),
  
  # Log variance ratio (lnVR)
  lnVR = log(sd_treatment/sd_control) + 
                (0.5 * ((1/(eff_n_treatment-1)) -    
                       (1/(eff_n_control-1)))), # Formula 5 in Senior et al. 2020
  
  # Sampling variance of lnVR
  var_lnVR = ifelse(n_cohort ==1, # If samples are independent
    
    0.5 * ((eff_n_control/((eff_n_control-1)^2)) + (eff_n_treatment/((eff_n_treatment-1)^2))), # Formula 15 in Senior et al. 2020
    (eff_n_control/(eff_n_control - 1)^2) - (0.5^2*(1/(eff_n_control-1))) + (0.5^4*((sd_control^8+sd_treatment^8)/(2*((eff_n_control-1)^2)*sd_control^4*sd_treatment^4))) # Formula 22 in Senior et al. 2020
  ),       
  
  # Log coefficient of variation ratio (lnCVR)
  lnCVR = log((sd_treatment/mean_treatment)/(sd_control/mean_control)) + 
                (0.5 * ((1/(eff_n_treatment-1)) -    
                       (1/(eff_n_control-1)))) + 
                (0.5 * ((sd_control^2/(eff_n_control*mean_control^2)) -    
                       (sd_treatment^2/(eff_n_treatment*mean_treatment^2)))), # Formula 6 in Senior et al. 2020
  
  # Sampling variance of lnCVR
  var_lnCVR = ifelse(n_cohort==1, # If samples are independent
              
              (sd_control^2/(eff_n_control*mean_control^2)) + 
              (sd_control^4/(2*eff_n_control^2*mean_control^4)) + 
              (eff_n_control/((eff_n_control-1)^2)) + 
              (sd_treatment^2/(eff_n_treatment*mean_treatment^2)) + 
              (sd_treatment^4/(2*eff_n_treatment^2*mean_treatment^4)) + 
              (eff_n_treatment/((eff_n_treatment-1)^2)), # Formula 16 in Senior et al. 2020
   
              (sd_control^2/(eff_n_control*mean_control^2)) + 
              (sd_treatment^2/(eff_n_treatment*mean_treatment^2)) + 
              (sd_control^4/(2*eff_n_control^2*mean_control^4)) + 
              (sd_treatment^4/(2*eff_n_treatment^2*mean_treatment^4)) - 
              (0.5 * ((2*sd_control*sd_treatment)/(eff_n_control*mean_control*mean_treatment))) + 
              (0.5^2 * (sd_control^2*sd_treatment^2*(mean_control^4+mean_treatment^4))/(2*eff_n_control^2*mean_control^4*mean_treatment^4)) + 
              (eff_n_control/((eff_n_control-1)^2)) - 
              (0.5^2 * (1/(eff_n_control-1))) + 
              (0.5^4 * (sd_control^8+sd_treatment^8)/(2*((eff_n_control-1)^2)*sd_control^4*sd_treatment^4)) # Formula 24 in Senior et al. 2020
  ))
```


## **Save processed dataset**
```{r, eval = F}
# Save processed data 
write.csv(processed_data, file = "data/processed_data.csv")
```

## **Account for data non-independence**

### **Phylogenetic variation** 
```{r, fig.width = 12, fig.height = 15}
processed_data <- read_csv(file = "data/processed_data.csv")

data <- processed_data
unique(data$species) # 25 species

# Match species to the OTL database
taxa <- unique(data$species)
resolved_names <- tnrs_match_names(taxa, context_name = "Animals")
resolved_names # All good, no approximate matches

# Create tree
tree <- tol_induced_subtree(ott_ids = resolved_names$ott_id)
tree$tip.label <- strip_ott_ids(tree$tip.label) # Remove ott IDs for presentation
#plot(tree, no.margin=TRUE, cex=1)

tree <- multi2di(tree, random = TRUE) # Resolve polytomy at random, but it matches classification from Cornetti et al. 2019. Molecular Phylogenetics and Evolution; with D. pulex and D. pulicaria being more closely related to eachother than D. magna
phylo_tree <- compute.brlen(tree, method = "Grafen", power = 1) # Compute branch lengths

# Plot tree
plot(phylo_tree)

# Compute phylogenetic correlation matrix
phylo_matrix <- vcv(phylo_tree, cor = T)  # The vcv function returns a variance-covariance matrix

# Add an additional column for phylogeny
data <- mutate(data, phylogeny = gsub(" ", "_", species),
               obs = row_number())

# Convert tibble to data frame
data <- as.data.frame(data)

# Rename trait type
data$trait_type <- factor(data$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

# Rename temperature regime
data$warm_cold <- factor(data$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))
```

### **Non-independence due to shared cohorts** 

Because different traits were sometimes measured on the cohort of animals, we account for this source of non-independence with a variance-covariance matrix to correlate errors of each trait (cf. Noble et al. 2017)
```{r}
# VCV matrix for lnRR 
VCV_lnRR <- vcalc(vi = var_lnRR,
                  cluster = shared_control_ID, 
                  rho = 0.5,
                  obs = obs,
                  data = data) 

# VCV matrix for lnCVR
VCV_lnCVR <- vcalc(vi = var_lnCVR,
                  cluster = shared_control_ID, 
                  rho = 0.5,
                  obs = obs,
                  data = data) 

# VCV matrix for lnVR
VCV_lnVR <- vcalc(vi = var_lnVR,
                  cluster = shared_control_ID, 
                  rho = 0.5,
                  obs = obs,
                  data = data) 
```


# **Overview of the dataset** 

```{r}
# Summarize overall metrics
overall <- data %>%
  summarise(
    Group = "Overall",
    `Number of Studies` = n_distinct(ref),
    `Number of Species` = n_distinct(species),
    `Number of Effect Sizes` = n_distinct(obs)
  )

# Summarize by trait
by_trait <- data %>%
  group_by(trait_type) %>%
  summarise(
    Group = paste("Trait -", unique(trait_type)),
    `Number of Studies` = n_distinct(ref),
    `Number of Species` = n_distinct(species),
    `Number of Effect Sizes` = n_distinct(obs)
  ) %>%
  ungroup()

# Summarize by temperature regime
by_temperature <- data %>%
  group_by(warm_cold) %>%
  summarise(
    Group = paste("Temperature regime -", unique(warm_cold)),
    `Number of Studies` = n_distinct(ref),
    `Number of Species` = n_distinct(species),
    `Number of Effect Sizes` = n_distinct(obs)
  ) %>%
  ungroup()

# Combine all summaries
table_sample_sizes <- bind_rows(overall, by_trait, by_temperature) %>% 
  dplyr::select(-trait_type, -warm_cold)

# Create the table
table_sample_sizes %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
    
```


# **Main meta-analytic models** 

Note that these models take a substantial amount of time to run. Therefore, these models were ran on the computational cluster Katana, supported by Research Technology Services at UNSW Sydney. 
Resources needed to run these models are provided in the /pbs/ folder, and the R code used for each model is in the R/models/ folder. 

## **Changes in trait means (lnRR)**  {.tabset .tabset_fade .tabset_pills}

### **Overall model**

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnRR ~ trait_type -1 + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnRR_model_overall <- brm(formula, 
                           family = gaussian(),
                           data = data, 
                           data2 = list(phylo_matrix = phylo_matrix,
                                        VCV_lnRR = VCV_lnRR),
                           prior = prior,
                           control = list(adapt_delta = 0.99, max_treedepth = 15),
                           iter = 4000, 
                           warmup = 2000,
                           chains = 4, 
                           cores = 4, 
                           seed = 123) 

# Save model
saveRDS(lnRR_model_overall, file = "RData/lnRR_model_overall.rds")
```

#### *Model output*
```{r}
# Load model
lnRR_model_overall <- readRDS("RData/lnRR_model_overall.rds")

# Display model output 
summary(lnRR_model_overall)

# Cleaned model output
as.data.frame(fixef(lnRR_model_overall, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+)", "\\1", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Heterogeneity analysis*
```{r}
# Extracting the posterior distribution from the model
posterior <- posterior_samples(lnRR_model_overall)

# Calculate measurement error variance
sigma2_v <- sum(1/diag(VCV_lnRR)) * (length(diag(VCV_lnRR))- 1)/(sum(1/diag(VCV_lnRR))^2 - sum((1/diag(VCV_lnRR))^2))

# Calculate the total variance (including the measurement error variance)
var_total <- posterior$sd_experiment_ID__Intercept +
             posterior$sd_obs__Intercept +
             posterior$sd_phylogeny__Intercept +
             posterior$sd_ref__trait_typebody_size +
             posterior$sd_ref__trait_typefecundity +
             posterior$sd_ref__trait_typesurvival +
             posterior$sd_species__Intercept +
             sigma2_v

# Calculate heterogeneity (I2)
I2 <- list(
    I2_total = (var_total - sigma2_v) / var_total, # Total heterogeneity
    I2_study = (posterior$sd_ref__trait_typebody_size + # Heterogeneity explained by study differences
                posterior$sd_ref__trait_typefecundity +
                posterior$sd_ref__trait_typesurvival) / var_total,
    I2_exp = posterior$sd_experiment_ID__Intercept / var_total, # Heterogeneity explained by experiment differences
    I2_sp = posterior$sd_species__Intercept / var_total, # Heterogeneity explained by species differences
    I2_phylo = posterior$sd_phylogeny__Intercept / var_total, # Heterogeneity explained by phylogenetic relatedness
    I2_obs = posterior$sd_obs__Intercept / var_total # Heterogeneity explained by residual variation

)

# Calculate mean and credible intervals 
summary_table <- t(sapply(I2, function(x) {
    c(Mean = 100*round(mean(x),4), 
      ` ` = 100* round(quantile(x, 0.025),4), 
      ` ` = 100*round(quantile(x, 0.975),4))
}))

# Customise table
summary_table <- summary_table %>%
    as.data.frame() %>% 
    rownames_to_column("Variable") %>%
    mutate(
        Variable = recode(Variable,
                          "I2_total"  = "Total",
                          "I2_study"  = "Study",
                          "I2_exp"    = "Experiment",
                          "I2_sp"     = "Species",
                          "I2_phylo"  = "Phylogeny",
                          "I2_obs"    = "Residual")
    ) %>%
    rename(
        lower_HPD = ` .2.5%`,
        upper_HPD = ` .97.5%`
    ) %>%
  mutate(
    Variable = paste0("I<sup>2</sup><sub>", Variable)   # Create a new column with formatted I² and subscripts
  )


# Display table
kable(summary_table, "html", escape = FALSE, 
      col.names = c("Heterogeneity (%)", "Mean", "Lower HPD", "Upper HPD"),
      align = c('l', 'r', 'r', 'r')) %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, width = "200px", bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```


#### *Data visualisation*
```{r, fig.width = 12, fig.height=7}
# Generate predictions
emmeans_overall <- as.data.frame(emmeans(lnRR_model_overall, ~ trait_type))

emmeans_overall$trait_type <- factor(emmeans_overall$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

# Calculate sample sizes and study counts
sample_sizes_traits <- data %>%
  group_by(trait_type) %>%
  summarise(
    estimates = n(),
    studies = n_distinct(ref)
  )

# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_quasirandom(data = data, # Plot effect sizes, scaled by precision
                     aes(x = trait_type, 
                         y = lnRR, 
                         size = 1/sqrt(var_lnRR)), 
                     fill = "gray75",
                     shape = 21,
                     width = 0.25, 
                     alpha = 0.2) +
    geom_errorbar(data = emmeans_overall,   # Plot the point estimates in white for background
                  aes(ymin = lower.HPD, 
                      ymax = upper.HPD,
                      x = trait_type), 
                  size = 2,
                  width = 0.085,
                  color = "white") +
    geom_point(data = emmeans_overall, # Plot the credible intervals in white for background
               aes(x = trait_type, 
                   y = emmean),
               size = 4.5, 
               stroke = 1.5,
               shape = 21,
               color="white",
               fill = "white") +
    geom_errorbar(data = emmeans_overall,  # Plot the point estimates 
                  aes(x = trait_type, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  size = 1.5,
                  width = 0.075,
                  color = "black") +
    geom_point(data = emmeans_overall, # Plot the credible intervals
               aes(x = trait_type, 
                   y = emmean),
               size = 4,
               shape = 21,
               stroke = 1.5,
               color="black",
               fill = "white") +
    geom_text(data = sample_sizes_traits,  # Sample size annotations 
              aes(x = trait_type, 
                  y = 1.5,
                  label = paste0("k = ", estimates, " (", studies, ")")), 
              hjust = 1, size = 5, show.legend = FALSE) +
    theme_bw() +     # Customize the plot
    labs(y = "lnRR", x = "") +
    scale_size_continuous(range = c(2, 8))+ 
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5)) +
    guides(color = "none", size = "none")+
    coord_flip() + 
    ylim(-1.5, 1.5)

# Save figure
ggsave(file = "fig/lnRR_overall.png", width = 12, height = 7, dpi = 500)
```

### **Temperature regime** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnRR ~ trait_type:warm_cold -1 + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnRR_model_warm_cold <- brm(formula, 
                  family = gaussian(),
                  data = data, 
                  data2 = list(phylo_matrix = phylo_matrix,
                               VCV_lnRR = VCV_lnRR),
                  prior = prior,
                  control = list(adapt_delta = 0.99, max_treedepth = 15),
                  iter = 4000, 
                  warmup = 2000,
                  chains = 4, 
                  cores = 4, 
                  seed = 123) 

# Save model
saveRDS(lnRR_model_warm_cold, file = "RData/lnRR_model_warm_cold.rds")
```

#### *Model output*
```{r}
# Load model
lnRR_model_warm_cold <- readRDS("RData/lnRR_model_warm_cold.rds")

# Display model output 
summary(lnRR_model_warm_cold)

# Cleaned model output
as.data.frame(fixef(lnRR_model_warm_cold, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Contrasts* 
```{r}
# Generate predictions
emms <- emmeans(lnRR_model_warm_cold, 
                specs = ~ warm_cold | trait_type)

# Generate contrasts
contrast(emms, method = "pairwise")
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=7}
# Generate predictions
emmeans_warm_cold <- as.data.frame(emmeans(lnRR_model_warm_cold, 
                                           specs = ~ warm_cold | trait_type))

emmeans_warm_cold$trait_type <- factor(emmeans_warm_cold$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_warm_cold$warm_cold <- factor(emmeans_warm_cold$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Calculate sample sizes and study counts
sample_sizes <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarise(
    estimates = n(),
    studies = n_distinct(ref)
  )

# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_quasirandom(data = data,     # Plot effect sizes, scaled by precision
                     aes(x = trait_type:warm_cold, 
                         y = lnRR, 
                         fill = trait_type:warm_cold, 
                         size = 1/sqrt(var_lnRR)), 
                     color = "black",
                     shape = 21,
                     width = 0.25, 
                     alpha = 0.3) +
    geom_errorbar(data = emmeans_warm_cold,  # Plot the point estimates in white for background
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.5,
                  width = 0.17) +
    geom_point(data = emmeans_warm_cold,  # Plot the credible intervals in white for background
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 21,
               size = 4, 
               stroke = 2,
               color="white",
               fill = "white") +
    geom_errorbar(data = emmeans_warm_cold, # Plot the point estimates 
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="black",
                  size = 2,
                  width = 0.15) +
    geom_point(data = emmeans_warm_cold, # Plot the credible intervals
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 21,
               size = 3.5, 
               stroke = 2,
               color="black",
               fill = "white") +
    geom_text(data = sample_sizes,  # Sample size annotations 
              aes(x = trait_type:warm_cold, 
                  y = 1.5,
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1, size = 5, show.legend = FALSE) +
    theme_bw() +     # Customize the plot
    labs(y = "lnRR", x = "") +
    scale_size_continuous(range = c(2, 8))+ 
#    scale_fill_manual(values = c("#A5F820", "#73B706",  "#9CEFFC", "#06A2BA",  "#FED2ED", "#B90674"))+
    scale_fill_manual(values = c("#06B4BA", "#E80756", "#06B4BA", "#E80756", "#06B4BA", "#E80756"))+
    scale_color_manual(values = c("Cold" = "#06B4BA", "Warm" = "#E80756")) +  # Text colour
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5)) +
    guides(fill = "none", size = "none")+
    coord_flip() + 
    ylim(-1.5, 1.5)

ggsave(file = "fig/lnRR_warm_cold.png", width = 12, height = 7, dpi = 500)
```

### **Assay temperature difference** 

We calculated the difference between the assay temperature and control temperature (assay_temp_diff) to account for the fact that animals were tested to a different range of temperatures. We also predicted that effects will vary if traits are assayed at colder- or warmer-than-control conditions, depending on the temperature regime. 
Because the variation in assay temperature generates some nuisance heterogeneity (sensu Noble et al., 2017), the results of subsequent models were provided after controlling for assay temperature differences. In order words, the results of all moderators are conditional on assay temperature, meaning that results are interpretable as the difference between control and selected lines, when animals are tested at the control temperature. 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnRR ~ 0 + trait_type:warm_cold + trait_type:warm_cold:assay_temp_diff + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnRR_model_assay_temp_diff <- brm(formula, 
                                  family = gaussian(),
                                  data = data, 
                                  data2 = list(phylo_matrix = phylo_matrix,
                                               VCV_lnRR = VCV_lnRR),
                                  prior = prior,
                                  control = list(adapt_delta = 0.99, max_treedepth = 15),
                                  iter = 4000, 
                                  warmup = 2000,
                                  chains = 4, 
                                  cores = 4, 
                                  seed = 123) 

# Save model
saveRDS(lnRR_model_assay_temp_diff, file = "RData/lnRR_model_assay_temp_diff.rds")
```

#### *Model output*
```{r}
# Load model
lnRR_model_assay_temp_diff <- readRDS("RData/lnRR_model_assay_temp_diff.rds")

# Display model output 
summary(lnRR_model_assay_temp_diff)

# Cleaned model output
as.data.frame(fixef(lnRR_model_assay_temp_diff, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    Parameter = gsub("trait_type([a-z_]+)\\(warm\\):assay_temp_diff", "\\1(warm): assay_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_assay_temp_diff <- as.data.frame(emmeans(
  lnRR_model_assay_temp_diff,
  specs = ~ assay_temp_diff | trait_type * warm_cold,
  at = list(assay_temp_diff = seq(min(data$assay_temp_diff), max(data$assay_temp_diff), by = 0.5)))
  )

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

emmeans_assay_temp_diff$trait_type <- factor(emmeans_assay_temp_diff$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_assay_temp_diff$warm_cold <- factor(emmeans_assay_temp_diff$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_assay_temp_diff <- emmeans_assay_temp_diff %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_point(data = data, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_assay_temp_diff, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_assay_temp_diff,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
      geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.9, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnRR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    ylim(-1.5, 1.5)

ggsave(file = "fig/lnRR_assay_temp_diff.png", width = 12, height = 10, dpi = 500)
```

### **Selection temperature** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnRR ~ 0 + trait_type:warm_cold + 
                         trait_type:warm_cold:assay_temp_diff + 
                         trait_type:warm_cold:select_temp_diff + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnRR_model_sel_temp_diff <- brm(formula, 
                                family = gaussian(),
                                data = data, 
                                data2 = list(phylo_matrix = phylo_matrix,
                                             VCV_lnRR = VCV_lnRR),
                                prior = prior,
                                control = list(adapt_delta = 0.99, max_treedepth = 15),
                                iter = 4000, 
                                warmup = 2000,
                                chains = 4, 
                                cores = 4, 
                                seed = 123) 

# Save model
saveRDS(lnRR_model_sel_temp_diff, file = "RData/lnRR_model_sel_temp_diff.rds")
```

#### *Model output*
```{r}
# Load model
lnRR_model_sel_temp_diff <- readRDS("RData/lnRR_model_sel_temp_diff.rds")

# Display model output 
summary(lnRR_model_sel_temp_diff)

# Cleaned model output
as.data.frame(fixef(lnRR_model_sel_temp_diff, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    Parameter = gsub("trait_type([a-z_]+)\\(warm\\):select_temp_diff", "\\1(warm): select_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_sel_temp_diff <- as.data.frame(emmeans(
  lnRR_model_sel_temp_diff,
  specs = ~ select_temp_diff | trait_type * warm_cold,
  at = list(select_temp_diff = seq(min(data$select_temp_diff), max(data$select_temp_diff), by = 0.5),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_select_temp_diff = min(select_temp_diff),
    max_select_temp_diff = max(select_temp_diff)
  )

emmeans_sel_temp_diff$trait_type <- factor(emmeans_sel_temp_diff$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_sel_temp_diff$warm_cold <- factor(emmeans_sel_temp_diff$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_sel_temp_diff <- emmeans_sel_temp_diff %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    select_temp_diff >= min_select_temp_diff,
    select_temp_diff <= max_select_temp_diff
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = select_temp_diff, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_sel_temp_diff, # Shaded area for credible intervals
                 aes(x = select_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_sel_temp_diff, # Predicted regression line
               aes(y = emmean,
                   x = select_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.9, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Selection temperature difference", y = "lnRR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    ylim(-1.5, 1.5)

ggsave(file = "fig/lnRR_sel_temp_diff.png", width = 12, height = 7, dpi = 500)
```


### **Number of generations of selection** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnRR ~ 0 + trait_type:warm_cold + 
                         trait_type:warm_cold:assay_temp_diff + 
                         trait_type:warm_cold:scale(gen_selection) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnRR_model_gen_selection <- brm(formula, 
                                family = gaussian(),
                                data = data, 
                                data2 = list(phylo_matrix = phylo_matrix,
                                             VCV_lnRR = VCV_lnRR),
                                prior = prior,
                                control = list(adapt_delta = 0.99, max_treedepth = 15),
                                iter = 4000, 
                                warmup = 2000,
                                chains = 4, 
                                cores = 4, 
                                seed = 123) 
# Save model
saveRDS(lnRR_model_gen_selection, file = "RData/lnRR_model_gen_selection.rds")
```

#### *Model output*
```{r}
# Load model
lnRR_model_gen_selection <- readRDS("RData/lnRR_model_gen_selection.rds")

# Display model output 
summary(lnRR_model_gen_selection)

# Cleaned model output
as.data.frame(fixef(lnRR_model_gen_selection, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from gen_selection
    Parameter = gsub("scalegen_selection", "gen_selection", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=10}

# Generate predictions
emmeans_gen_selection <- as.data.frame(emmeans(
  lnRR_model_gen_selection,
  specs = ~ gen_selection | trait_type * warm_cold,
  at = list(gen_selection = seq(min(data$gen_selection), max(data$gen_selection), by = 0.5),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_gen_selection = min(gen_selection),
    max_gen_selection = max(gen_selection)
  )

emmeans_gen_selection$trait_type <- factor(emmeans_gen_selection$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_gen_selection$warm_cold <- factor(emmeans_gen_selection$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_gen_selection <- emmeans_gen_selection %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    gen_selection >= min_gen_selection,
    gen_selection <= max_gen_selection
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = gen_selection, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_gen_selection, # Shaded area for credible intervals
                 aes(x = gen_selection,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_gen_selection, # Predicted regression line
               aes(y = emmean,
                   x = gen_selection,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.9, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Number  of generations of selection", y = "lnRR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    ylim(-1.5, 1.5)+
    xlim(0, 150)

ggsave(file = "fig/lnRR_gen_selection.png", width = 12, height = 7, dpi = 500)
```

### **Number of generations of common garden** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnRR ~ 0 + trait_type:warm_cold + 
                         trait_type:warm_cold:assay_temp_diff + 
                         trait_type:warm_cold:scale(gen_common_garden) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnRR_model_gen_common_garden <- brm(formula, 
                                family = gaussian(),
                                data = data, 
                                data2 = list(phylo_matrix = phylo_matrix,
                                             VCV_lnRR = VCV_lnRR),
                                prior = prior,
                                control = list(adapt_delta = 0.99, max_treedepth = 15),
                                iter = 4000, 
                                warmup = 2000,
                                chains = 4, 
                                cores = 4, 
                                seed = 123) 
# Save model
saveRDS(lnRR_model_gen_common_garden, file = "RData/lnRR_model_gen_common_garden.rds")
```

#### *Model output*
```{r}
# Load model
lnRR_model_gen_common_garden <- readRDS("RData/lnRR_model_gen_common_garden.rds")

# Display model output 
summary(lnRR_model_gen_common_garden)

# Cleaned model output
as.data.frame(fixef(lnRR_model_gen_common_garden, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from gen_common_garden
    Parameter = gsub("scalegen_common_garden", "gen_common_garden", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=10}

# Generate predictions
emmeans_gen_common_garden <- as.data.frame(emmeans(
  lnRR_model_gen_common_garden,
  specs = ~ gen_common_garden | trait_type * warm_cold,
  at = list(gen_common_garden = seq(min(data$gen_common_garden), max(data$gen_common_garden), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0


# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_gen_common_garden = min(gen_common_garden),
    max_gen_common_garden = max(gen_common_garden)
  )

emmeans_gen_common_garden$trait_type <- factor(emmeans_gen_common_garden$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_gen_common_garden$warm_cold <- factor(emmeans_gen_common_garden$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_gen_common_garden <- emmeans_gen_common_garden %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    gen_common_garden >= min_gen_common_garden,
    gen_common_garden <= max_gen_common_garden
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = gen_common_garden, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_gen_common_garden, # Shaded area for credible intervals
                 aes(x = gen_common_garden,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_gen_common_garden, # Predicted regression line
               aes(y = emmean,
                   x = gen_common_garden,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.9, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Number of generations of common garden", y = "lnRR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-1.5, 1.5),
                    xlim = c(0, 12))

ggsave(file = "fig/lnRR_gen_common_garden.png", width = 12, height = 7, dpi = 500)
```

### **Population size** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnRR ~ 0 + trait_type:warm_cold + 
                         trait_type:warm_cold:assay_temp_diff + 
                         trait_type:warm_cold:scale(pop_size) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnRR_model_pop_size <- brm(formula, 
                                family = gaussian(),
                                data = data, 
                                data2 = list(phylo_matrix = phylo_matrix,
                                             VCV_lnRR = VCV_lnRR),
                                prior = prior,
                                control = list(adapt_delta = 0.99, max_treedepth = 15),
                                iter = 4000, 
                                warmup = 2000,
                                chains = 4, 
                                cores = 4, 
                                seed = 123) 
# Save model
saveRDS(lnRR_model_pop_size, file = "RData/lnRR_model_pop_size.rds")
```

#### *Model output*
```{r}
# Load model
lnRR_model_pop_size <- readRDS("RData/lnRR_model_pop_size.rds")

# Display model output 
summary(lnRR_model_pop_size)

# Cleaned model output
as.data.frame(fixef(lnRR_model_pop_size, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from pop_size
    Parameter = gsub("scalepop_size", "pop_size", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=10}

# Generate predictions
emmeans_pop_size <- as.data.frame(emmeans(
  lnRR_model_pop_size,
  specs = ~ pop_size | trait_type * warm_cold,
  at = list(pop_size = seq(min(data$pop_size, na.rm=T), max(data$pop_size, na.rm=T), by = 50),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0


# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_pop_size = min(pop_size, na.rm=T),
    max_pop_size = max(pop_size, na.rm=T)
  )

emmeans_pop_size$trait_type <- factor(emmeans_pop_size$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_pop_size$warm_cold <- factor(emmeans_pop_size$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_pop_size <- emmeans_pop_size %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    pop_size >= min_pop_size,
    pop_size <= max_pop_size
  )

# Calculate sample sizes and study counts for population size
sample_sizes_pop_size <- data %>%
  filter(is.na(pop_size)==FALSE) %>% 
  group_by(trait_type, warm_cold) %>%
  summarise(
    estimates = n(),
    studies = n_distinct(ref)
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = pop_size, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_pop_size, # Shaded area for credible intervals
                 aes(x = pop_size,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_pop_size, # Predicted regression line
               aes(y = emmean,
                   x = pop_size,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes_pop_size, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.9, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Population size", y = "lnRR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-1.5, 1.5))

ggsave(file = "fig/lnRR_pop_size.png", width = 12, height = 7, dpi = 500)
```


### **All moderators** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnRR ~ 0 + trait_type:warm_cold + 
                trait_type:warm_cold:assay_temp_diff + 
                trait_type:warm_cold:scale(select_temp_diff) +
                trait_type:warm_cold:scale(gen_selection) + 
                trait_type:warm_cold:scale(gen_common_garden) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnRR_model_all_moderators <- brm(formula, 
                                  family = gaussian(),
                                  data = data, 
                                  data2 = list(phylo_matrix = phylo_matrix,
                                               VCV_lnRR = VCV_lnRR),
                                  prior = prior,
                                  control = list(adapt_delta = 0.99, max_treedepth = 15),
                                  iter = 4000, 
                                  warmup = 2000,
                                  chains = 4, 
                                  cores = 4, 
                                  seed = 123) 

# Save model
saveRDS(lnRR_model_all_moderators, file = "RData/lnRR_model_all_moderators.rds")
```

#### *Model output*
```{r}
# Load model
lnRR_model_all_moderators <- readRDS("RData/lnRR_model_all_moderators.rds")

# Display model output 
summary(lnRR_model_all_moderators)

# Cleaned model output
as.data.frame(fixef(lnRR_model_all_moderators, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from all moderator variables
    Parameter = gsub("scale", "", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
 
# Generate predicted values at different assay temperatures
emmeans_full_model <- as.data.frame(emmeans(
  lnRR_model_all_moderators,
  specs = ~ assay_temp_diff * select_temp_diff * gen_selection * gen_common_garden | trait_type * warm_cold,
  at = list(assay_temp_diff = c(-8.5, -4, 0, 4, 5, -5, 17, 20)) # Predict at unique min, control, max values
))

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay = min(assay_temp_diff),
    max_assay = max(assay_temp_diff),
    control_assay = 0
  )

emmeans_full_model$trait_type <- factor(emmeans_full_model$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_full_model$warm_cold <- factor(emmeans_full_model$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_full_model %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff == min_assay |
    assay_temp_diff == max_assay |
    assay_temp_diff == control_assay) %>% 
    dplyr::select(-min_assay, -max_assay, -control_assay) %>% 
    mutate(percentage_change = (exp(emmean) - 1) * 100,
           percentage_lower_HPD = (exp(lower.HPD) - 1) * 100,
           percentage_upper_HPD = (exp(upper.HPD) - 1) * 100) %>%
  mutate(across(c(emmean, 
                  lower.HPD, 
                  upper.HPD, 
                  percentage_change,
                  percentage_lower_HPD, 
                  percentage_upper_HPD), ~ round(., 3))) %>%   # Round numbers to 3 decimal points
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

**Marginal means** 
```{r, fig.width = 12, fig.height=10}
# Generate predictions at assay_temp_diff = 0, or 5 degrees below or above the control temperatures
emmeans_full_model <- as.data.frame(emmeans(
  lnRR_model_all_moderators,
  specs = ~ assay_temp_diff * select_temp_diff * gen_selection * gen_common_garden | trait_type * warm_cold,
  at = list(assay_temp_diff = c(-5, 0, 5) # Re-acclimated to control, or 5 degrees above/below the control
  ))) 

# Rename variable levels
emmeans_full_model$trait_type <- factor(emmeans_full_model$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_full_model$warm_cold <- factor(emmeans_full_model$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))
emmeans_full_model

# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_quasirandom(data = data,     # Plot effect sizes, scaled by precision
                     aes(x = trait_type:warm_cold, 
                         y = lnRR, 
                         fill = trait_type:warm_cold, 
                         size = 1/sqrt(var_lnRR)), 
                     color = "black",
                     shape = 21,
                     width = 0.3, 
                     alpha = 0.3) +
    geom_errorbar(data = filter(emmeans_full_model,
                                assay_temp_diff == "-5"),  # 5 degrees below control (background)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.75,
                  width = 0.16,
               position = position_nudge(x=-0.25)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "-5"),  # 5 degrees below control (background)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 21,
               size = 4.5, 
               stroke = 2,
               color="white",
               fill = "white",
               position = position_nudge(x=-0.25)) +
    geom_errorbar(data = filter(emmeans_full_model,
                             assay_temp_diff == "-5"), # 5 degrees below control (credible intervals)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="#06B4BA",
                  size = 2,
                  width = 0.12,
               position = position_nudge(x=-0.25)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "-5"), # 5 degrees below control  (point estimates)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 21,
               size = 3.5, 
               stroke = 2,
               color="#06B4BA",
               fill = "white",
               position = position_nudge(x=-0.25)) +

      geom_errorbar(data = filter(emmeans_full_model,
                                assay_temp_diff == "0"),  # control temperature (background)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.75,
                  width = 0.16,
               position = position_nudge(x=0)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "0"),  # control temperature (background)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 22,
               size = 4.5, 
               stroke = 2,
               color="white",
               fill = "white",
               position = position_nudge(x=0)) +
    geom_errorbar(data = filter(emmeans_full_model,
                             assay_temp_diff == "0"), # control temperature (credible intervals)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="black",
                  size = 2,
                  width = 0.12,
               position = position_nudge(x=0)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "0"), # control temperature (point estimates)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 22,
               size = 3.5, 
               stroke = 2,
               color="black",
               fill = "white",
               position = position_nudge(x=0)) +
  
      geom_errorbar(data = filter(emmeans_full_model,
                                assay_temp_diff == "5"),  # 5 degrees above control (background)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.75,
                  width = 0.16,
               position = position_nudge(x=0.25)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "5"),  # 5 degrees above control (background)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 23,
               size = 4.5, 
               stroke = 2,
               color="white",
               fill = "white",
               position = position_nudge(x=0.25)) +
    geom_errorbar(data = filter(emmeans_full_model,
                             assay_temp_diff == "5"), # 5 degrees above control (credible intervals)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="#E80756",
                  size = 2,
                  width = 0.12,
               position = position_nudge(x=0.25)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "5"), # 5 degrees above control (point estimates)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 23,
               size = 3.5, 
               stroke = 2,
               color="#E80756",
               fill = "white",
               position = position_nudge(x=0.25)) +
  
    geom_text(data = sample_sizes,  # Sample size annotations 
              aes(x = trait_type:warm_cold, 
                  y = 1.5,
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1, size = 5, show.legend = FALSE) +
  
    theme_bw() +     # Customize the plot
    labs(y = "lnRR", x = "") +
    scale_size_continuous(range = c(2, 8))+ 
    scale_fill_manual(values = c("#06B4BA", "#E80756", "#06B4BA", "#E80756", "#06B4BA", "#E80756"))+
    scale_color_manual(values = c("Cold" = "#06B4BA", "Warm" = "#E80756")) +  # Text colour
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5)) +
    guides(fill = "none", size = "none")+
    coord_flip() + 
    ylim(-1.5, 1.5)

ggsave(file = "fig/lnRR_all_moderators_marginal_means.png", width = 12, height = 8, dpi = 500)
```

**Overall trend with assay temperature** 
```{r, fig.width = 12, fig.height=10}
# Generate predictions for all assay temperatures
emmeans_full_model_assay <- as.data.frame(emmeans(
  lnRR_model_all_moderators,
  specs = ~ assay_temp_diff * select_temp_diff * gen_selection * gen_common_garden | trait_type * warm_cold,
  at = list(assay_temp_diff = seq(min(data$assay_temp_diff), max(data$assay_temp_diff), by = 0.5) # Re-acclimated to control, or 5 degrees above/below the contol
  ))) 

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

# Rename variable levels
emmeans_full_model_assay$trait_type <- factor(emmeans_full_model_assay$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_full_model_assay$warm_cold <- factor(emmeans_full_model_assay$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_full_model_assay <- emmeans_full_model_assay %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )


# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_full_model_assay, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_full_model_assay,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
  
    geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnRR",
       col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3, 3))

ggsave(file = "fig/lnRR_all_moderators_assay_temp_diff.png", width = 12, height = 10, dpi = 500)
```


## **Changes in relative trait variance (lnCVR)** {.tabset .tabset_fade .tabset_pills}

### **Overall model**

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnCVR ~ trait_type -1 + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnCVR_model_overall <- brm(formula, 
                           family = gaussian(),
                           data = data, 
                           data2 = list(phylo_matrix = phylo_matrix,
                                        VCV_lnCVR = VCV_lnCVR),
                           prior = prior,
                           control = list(adapt_delta = 0.99, max_treedepth = 15),
                           iter = 4000, 
                           warmup = 2000,
                           chains = 4, 
                           cores = 4, 
                           seed = 123) 

# Save model
saveRDS(lnCVR_model_overall, file = "RData/lnCVR_model_overall.rds")
```

#### *Model output*
```{r}
# Load model
lnCVR_model_overall <- readRDS("RData/lnCVR_model_overall.rds")

# Display model output 
summary(lnCVR_model_overall)

# Cleaned model output
as.data.frame(fixef(lnCVR_model_overall, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+)", "\\1", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```


#### *Heterogeneity analysis*
```{r}
# Extracting the posterior distribution from the model
posterior <- posterior_samples(lnCVR_model_overall)

# Calculate measurement error variance
sigma2_v <- sum(1/diag(VCV_lnCVR)) * (length(diag(VCV_lnCVR))- 1)/(sum(1/diag(VCV_lnCVR))^2 - sum((1/diag(VCV_lnCVR))^2))

# Calculate the total variance (including the measurement error variance)
var_total <- posterior$sd_experiment_ID__Intercept +
             posterior$sd_obs__Intercept +
             posterior$sd_phylogeny__Intercept +
             posterior$sd_ref__trait_typebody_size +
             posterior$sd_ref__trait_typefecundity +
             posterior$sd_ref__trait_typesurvival +
             posterior$sd_species__Intercept +
             sigma2_v

# Calculate heterogeneity (I2)
I2 <- list(
    I2_total = (var_total - sigma2_v) / var_total, # Total heterogeneity
    I2_study = (posterior$sd_ref__trait_typebody_size + # Heterogeneity explained by study differences
                posterior$sd_ref__trait_typefecundity +
                posterior$sd_ref__trait_typesurvival) / var_total,
    I2_exp = posterior$sd_experiment_ID__Intercept / var_total, # Heterogeneity explained by experiment differences
    I2_sp = posterior$sd_species__Intercept / var_total, # Heterogeneity explained by species differences
    I2_phylo = posterior$sd_phylogeny__Intercept / var_total, # Heterogeneity explained by phylogenetic relatedness
    I2_obs = posterior$sd_obs__Intercept / var_total # Heterogeneity explained by residual variation

)

# Calculate mean and credible intervals 
summary_table <- t(sapply(I2, function(x) {
    c(Mean = 100*round(mean(x),4), 
      ` ` = 100* round(quantile(x, 0.025),4), 
      ` ` = 100*round(quantile(x, 0.975),4))
}))

# Customise table
summary_table <- summary_table %>%
    as.data.frame() %>% 
    rownames_to_column("Variable") %>%
    mutate(
        Variable = recode(Variable,
                          "I2_total"  = "Total",
                          "I2_study"  = "Study",
                          "I2_exp"    = "Experiment",
                          "I2_sp"     = "Species",
                          "I2_phylo"  = "Phylogeny",
                          "I2_obs"    = "Residual")
    ) %>%
    rename(
        lower_HPD = ` .2.5%`,
        upper_HPD = ` .97.5%`
    ) %>%
  mutate(
    Variable = paste0("I<sup>2</sup><sub>", Variable)   # Create a new column with formatted I² and subscripts
  )


# Display table
kable(summary_table, "html", escape = FALSE, 
      col.names = c("Heterogeneity (%)", "Mean", "Lower HPD", "Upper HPD"),
      align = c('l', 'r', 'r', 'r')) %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, width = "200px", bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=7}
# Generate predictions
emmeans_overall <- as.data.frame(emmeans(lnCVR_model_overall, ~ trait_type))

emmeans_overall$trait_type <- factor(emmeans_overall$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))
# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_quasirandom(data = data, # Plot effect sizes, scaled by precision
                     aes(x = trait_type, 
                         y = lnCVR, 
                         size = 1/sqrt(var_lnCVR)), 
                     fill = "gray75",
                     shape = 21,
                     width = 0.25, 
                     alpha = 0.2) +
    geom_errorbar(data = emmeans_overall,   # Plot the point estimates in white for background
                  aes(ymin = lower.HPD, 
                      ymax = upper.HPD,
                      x = trait_type), 
                  size = 2,
                  width = 0.085,
                  color = "white") +
    geom_point(data = emmeans_overall, # Plot the credible intervals in white for background
               aes(x = trait_type, 
                   y = emmean),
               size = 4.5, 
               stroke = 1.5,
               shape = 21,
               color="white",
               fill = "white") +
    geom_errorbar(data = emmeans_overall,  # Plot the point estimates 
                  aes(x = trait_type, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  size = 1.5,
                  width = 0.075,
                  color = "black") +
    geom_point(data = emmeans_overall, # Plot the credible intervals
               aes(x = trait_type, 
                   y = emmean),
               size = 4,
               shape = 21,
               stroke = 1.5,
               color="black",
               fill = "white") +
    geom_text(data = sample_sizes_traits,  # Sample size annotations 
              aes(x = trait_type, 
                  y = 3,
                  label = paste0("k = ", estimates, " (", studies, ")")), 
              hjust = 1, size = 5, show.legend = FALSE) +
    theme_bw() +     # Customize the plot
    labs(y = "lnCVR", x = "") +
    scale_size_continuous(range = c(2, 8))+ 
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5)) +
    guides(color = "none", size = "none")+
    coord_flip() + 
    ylim(-3, 3)

# Save figure
ggsave(file = "fig/lnCVR_overall.png", width = 12, height = 7, dpi = 500)
```

### **Temperature regime** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnCVR ~ trait_type:warm_cold -1 + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnCVR_model_warm_cold <- brm(formula, 
                  family = gaussian(),
                  data = data, 
                  data2 = list(phylo_matrix = phylo_matrix,
                               VCV_lnCVR = VCV_lnCVR),
                  prior = prior,
                  control = list(adapt_delta = 0.99, max_treedepth = 15),
                  iter = 4000, 
                  warmup = 2000,
                  chains = 4, 
                  cores = 4, 
                  seed = 123) 

# Save model
saveRDS(lnCVR_model_warm_cold, file = "RData/lnCVR_model_warm_cold.rds")
```

#### *Model output*
```{r}
# Load model
lnCVR_model_warm_cold <- readRDS("RData/lnCVR_model_warm_cold.rds")

# Display model output 
summary(lnCVR_model_warm_cold)

# Cleaned model output
as.data.frame(fixef(lnCVR_model_warm_cold, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Contrasts* 
```{r}
# Generate predictions
emms <- emmeans(lnCVR_model_warm_cold, 
                specs = ~ warm_cold | trait_type)

# Generate contrasts
contrast(emms, method = "pairwise")
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=7}
# Generate predictions
emmeans_warm_cold <- as.data.frame(emmeans(lnCVR_model_warm_cold, 
                                           specs = ~ warm_cold | trait_type))

emmeans_warm_cold$trait_type <- factor(emmeans_warm_cold$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))


emmeans_warm_cold$warm_cold <- factor(emmeans_warm_cold$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))
# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_quasirandom(data = data,     # Plot effect sizes, scaled by precision
                     aes(x = trait_type:warm_cold, 
                         y = lnCVR, 
                         fill = trait_type:warm_cold, 
                         size = 1/sqrt(var_lnCVR)), 
                     color = "black",
                     shape = 21,
                     width = 0.25, 
                     alpha = 0.3) +
    geom_errorbar(data = emmeans_warm_cold,  # Plot the point estimates in white for background
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.5,
                  width = 0.17) +
    geom_point(data = emmeans_warm_cold,  # Plot the credible intervals in white for background
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 21,
               size = 4, 
               stroke = 2,
               color="white",
               fill = "white") +
    geom_errorbar(data = emmeans_warm_cold, # Plot the point estimates 
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="black",
                  size = 2,
                  width = 0.15) +
    geom_point(data = emmeans_warm_cold, # Plot the credible intervals
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 21,
               size = 3.5, 
               stroke = 2,
               color="black",
               fill = "white") +
    geom_text(data = sample_sizes,  # Sample size annotations 
              aes(x = trait_type:warm_cold, 
                  y = 3,
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1, size = 5, show.legend = FALSE) +
    theme_bw() +     # Customize the plot
    labs(y = "lnCVR", x = "") +
    scale_size_continuous(range = c(2, 8))+ 
#    scale_fill_manual(values = c("#A5F820", "#73B706",  "#9CEFFC", "#06A2BA",  "#FED2ED", "#B90674"))+
    scale_fill_manual(values = c("#06B4BA", "#E80756", "#06B4BA", "#E80756", "#06B4BA", "#E80756"))+
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5)) +
    guides(fill = "none", size = "none")+
    coord_flip() + 
    ylim(-3, 3)

ggsave(file = "fig/lnCVR_warm_cold.png", width = 12, height = 7, dpi = 500)
```

### **Assay temperature difference** 

We calculated the difference between the assay temperature and control temperature (assay_temp_diff) to account for the fact that animals were tested to a different range of temperatures. We also predicted that effects will vary if traits are assayed at colder- or warmer-than-control conditions, depending on the temperature regime. 
Because the variation in assay temperature generates some nuisance heterogeneity (sensu Noble et al., 2017), the results of subsequent models were provided after controlling for assay temperature differences. In order words, the results of all moderators are conditional on assay temperature, meaning that results are interpretable as the difference between control and selected lines, when animals are tested at the control temperature. 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnCVR ~ 0 + trait_type:warm_cold + trait_type:warm_cold:assay_temp_diff + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnCVR_model_assay_temp_diff <- brm(formula, 
                                  family = gaussian(),
                                  data = data, 
                                  data2 = list(phylo_matrix = phylo_matrix,
                                               VCV_lnCVR = VCV_lnCVR),
                                  prior = prior,
                                  control = list(adapt_delta = 0.99, max_treedepth = 15),
                                  iter = 4000, 
                                  warmup = 2000,
                                  chains = 4, 
                                  cores = 4, 
                                  seed = 123) 

# Save model
saveRDS(lnCVR_model_assay_temp_diff, file = "RData/lnCVR_model_assay_temp_diff.rds")
```

#### *Model output*
```{r}
# Load model
lnCVR_model_assay_temp_diff <- readRDS("RData/lnCVR_model_assay_temp_diff.rds")

# Display model output 
summary(lnCVR_model_assay_temp_diff)

# Cleaned model output
as.data.frame(fixef(lnCVR_model_assay_temp_diff, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    Parameter = gsub("trait_type([a-z_]+)\\(warm\\):assay_temp_diff", "\\1(warm): assay_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_assay_temp_diff <- as.data.frame(emmeans(
  lnCVR_model_assay_temp_diff,
  specs = ~ assay_temp_diff | trait_type * warm_cold,
  at = list(assay_temp_diff = seq(min(data$assay_temp_diff), max(data$assay_temp_diff), by = 0.5)))
  )

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

emmeans_assay_temp_diff$trait_type <- factor(emmeans_assay_temp_diff$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_assay_temp_diff$warm_cold <- factor(emmeans_assay_temp_diff$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_assay_temp_diff <- emmeans_assay_temp_diff %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnCVR, 
                      size = 1/sqrt(var_lnCVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_assay_temp_diff, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_assay_temp_diff,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
  
    geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnCVR",
       col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3, 3))

ggsave(file = "fig/lnCVR_assay_temp_diff.png", width = 12, height = 10, dpi = 500)
```


### **Selection temperature** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnCVR ~ 0 + trait_type:warm_cold + 
                          trait_type:warm_cold:assay_temp_diff + 
                          trait_type:warm_cold:select_temp_diff + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnCVR_model_sel_temp_diff <- brm(formula, 
                                family = gaussian(),
                                data = data, 
                                data2 = list(phylo_matrix = phylo_matrix,
                                             VCV_lnCVR = VCV_lnCVR),
                                prior = prior,
                                control = list(adapt_delta = 0.99, max_treedepth = 15),
                                iter = 4000, 
                                warmup = 2000,
                                chains = 4, 
                                cores = 4, 
                                seed = 123) 

# Save model
saveRDS(lnCVR_model_sel_temp_diff, file = "RData/lnCVR_model_sel_temp_diff.rds")
```

#### *Model output*
```{r}
# Load model
lnCVR_model_sel_temp_diff <- readRDS("RData/lnCVR_model_sel_temp_diff.rds")

# Display model output 
summary(lnCVR_model_sel_temp_diff)

# Cleaned model output
as.data.frame(fixef(lnCVR_model_sel_temp_diff, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    Parameter = gsub("trait_type([a-z_]+)\\(warm\\):select_temp_diff", "\\1(warm): select_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_sel_temp_diff <- as.data.frame(emmeans(
  lnCVR_model_sel_temp_diff,
  specs = ~ select_temp_diff | trait_type * warm_cold,
  at = list(select_temp_diff = seq(min(data$select_temp_diff), max(data$select_temp_diff), by = 0.5),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_select_temp_diff = min(select_temp_diff),
    max_select_temp_diff = max(select_temp_diff)
  )

emmeans_sel_temp_diff$trait_type <- factor(emmeans_sel_temp_diff$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_sel_temp_diff$warm_cold <- factor(emmeans_sel_temp_diff$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_sel_temp_diff <- emmeans_sel_temp_diff %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    select_temp_diff >= min_select_temp_diff,
    select_temp_diff <= max_select_temp_diff
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = select_temp_diff, 
                      y = lnCVR, 
                      size = 1/sqrt(var_lnCVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_sel_temp_diff, # Shaded area for credible intervals
                 aes(x = select_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_sel_temp_diff, # Predicted regression line
               aes(y = emmean,
                   x = select_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Selection temperature difference", y = "lnCVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3, 3))

ggsave(file = "fig/lnCVR_sel_temp_diff.png", width = 12, height = 7, dpi = 500)
```


### **Number of generations of selection** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnCVR ~ 0 + trait_type:warm_cold + 
                          trait_type:warm_cold:assay_temp_diff + 
                          trait_type:warm_cold:scale(gen_selection) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnCVR_model_gen_selection <- brm(formula, 
                                family = gaussian(),
                                data = data, 
                                data2 = list(phylo_matrix = phylo_matrix,
                                             VCV_lnCVR = VCV_lnCVR),
                                prior = prior,
                                control = list(adapt_delta = 0.99, max_treedepth = 15),
                                iter = 4000, 
                                warmup = 2000,
                                chains = 4, 
                                cores = 4, 
                                seed = 123) 
# Save model
saveRDS(lnCVR_model_gen_selection, file = "RData/lnCVR_model_gen_selection.rds")
```

#### *Model output*
```{r}
# Load model
lnCVR_model_gen_selection <- readRDS("RData/lnCVR_model_gen_selection.rds")

# Display model output 
summary(lnCVR_model_gen_selection)

# Cleaned model output
as.data.frame(fixef(lnCVR_model_gen_selection, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from gen_selection
    Parameter = gsub("scalegen_selection", "gen_selection", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=10}

# Generate predictions
emmeans_gen_selection <- as.data.frame(emmeans(
  lnCVR_model_gen_selection,
  specs = ~ gen_selection | trait_type * warm_cold,
  at = list(gen_selection = seq(min(data$gen_selection), max(data$gen_selection), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0


# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_gen_selection = min(gen_selection),
    max_gen_selection = max(gen_selection)
  )

emmeans_gen_selection$trait_type <- factor(emmeans_gen_selection$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_gen_selection$warm_cold <- factor(emmeans_gen_selection$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_gen_selection <- emmeans_gen_selection %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    gen_selection >= min_gen_selection,
    gen_selection <= max_gen_selection
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = gen_selection, 
                      y = lnCVR, 
                      size = 1/sqrt(var_lnCVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_gen_selection, # Shaded area for credible intervals
                 aes(x = gen_selection,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_gen_selection, # Predicted regression line
               aes(y = emmean,
                   x = gen_selection,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Number of generations of selection", y = "lnCVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3, 3),
                    xlim = c(0, 150))

ggsave(file = "fig/lnCVR_gen_selection.png", width = 12, height = 7, dpi = 500)
```

### **Number of generations of common garden** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnCVR ~ 0 + trait_type:warm_cold + 
                          trait_type:warm_cold:assay_temp_diff + 
                          trait_type:warm_cold:scale(gen_common_garden) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnCVR_model_gen_common_garden <- brm(formula, 
                                family = gaussian(),
                                data = data, 
                                data2 = list(phylo_matrix = phylo_matrix,
                                             VCV_lnCVR = VCV_lnCVR),
                                prior = prior,
                                control = list(adapt_delta = 0.99, max_treedepth = 15),
                                iter = 4000, 
                                warmup = 2000,
                                chains = 4, 
                                cores = 4, 
                                seed = 123) 
# Save model
saveRDS(lnCVR_model_gen_common_garden, file = "RData/lnCVR_model_gen_common_garden.rds")
```

#### *Model output*
```{r}
# Load model
lnCVR_model_gen_common_garden <- readRDS("RData/lnCVR_model_gen_common_garden.rds")

# Display model output 
summary(lnCVR_model_gen_common_garden)

# Cleaned model output
as.data.frame(fixef(lnCVR_model_gen_common_garden, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from gen_common_garden
    Parameter = gsub("scalegen_common_garden", "gen_common_garden", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=10}

# Generate predictions
emmeans_gen_common_garden <- as.data.frame(emmeans(
  lnCVR_model_gen_common_garden,
  specs = ~ gen_common_garden | trait_type * warm_cold,
  at = list(gen_common_garden = seq(min(data$gen_common_garden), max(data$gen_common_garden), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_gen_common_garden = min(gen_common_garden),
    max_gen_common_garden = max(gen_common_garden)
  )

emmeans_gen_common_garden$trait_type <- factor(emmeans_gen_common_garden$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_gen_common_garden$warm_cold <- factor(emmeans_gen_common_garden$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_gen_common_garden <- emmeans_gen_common_garden %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    gen_common_garden >= min_gen_common_garden,
    gen_common_garden <= max_gen_common_garden
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = gen_common_garden, 
                      y = lnCVR, 
                      size = 1/sqrt(var_lnCVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_gen_common_garden, # Shaded area for credible intervals
                 aes(x = gen_common_garden,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_gen_common_garden, # Predicted regression line
               aes(y = emmean,
                   x = gen_common_garden,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Number of generations of common garden", y = "lnCVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3, 3),
                    xlim = c(0, 12))

ggsave(file = "fig/lnCVR_gen_common_garden.png", width = 12, height = 7, dpi = 500)
```

### **Population size** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnCVR ~ 0 + trait_type:warm_cold + 
                          trait_type:warm_cold:assay_temp_diff + 
                          trait_type:warm_cold:scale(pop_size) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnCVR_model_pop_size <- brm(formula, 
                                family = gaussian(),
                                data = data, 
                                data2 = list(phylo_matrix = phylo_matrix,
                                             VCV_lnCVR = VCV_lnCVR),
                                prior = prior,
                                control = list(adapt_delta = 0.99, max_treedepth = 15),
                                iter = 4000, 
                                warmup = 2000,
                                chains = 4, 
                                cores = 4, 
                                seed = 123) 
# Save model
saveRDS(lnCVR_model_pop_size, file = "RData/lnCVR_model_pop_size.rds")
```

#### *Model output*
```{r}
# Load model
lnCVR_model_pop_size <- readRDS("RData/lnCVR_model_pop_size.rds")

# Display model output 
summary(lnCVR_model_pop_size)

# Cleaned model output
as.data.frame(fixef(lnCVR_model_pop_size, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from pop_size
    Parameter = gsub("scalepop_size", "pop_size", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)

```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=10}

# Generate predictions
emmeans_pop_size <- as.data.frame(emmeans(
  lnCVR_model_pop_size,
  specs = ~ pop_size | trait_type * warm_cold,
  at = list(pop_size = seq(min(data$pop_size, na.rm=T), max(data$pop_size, na.rm=T), by = 50),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_pop_size = min(pop_size, na.rm=T),
    max_pop_size = max(pop_size, na.rm=T)
  )

emmeans_pop_size$trait_type <- factor(emmeans_pop_size$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_pop_size$warm_cold <- factor(emmeans_pop_size$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_pop_size <- emmeans_pop_size %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    pop_size >= min_pop_size,
    pop_size <= max_pop_size
  )

# Calculate sample sizes and study counts for population size
sample_sizes_pop_size <- data %>%
  filter(is.na(pop_size)==FALSE) %>% 
  group_by(trait_type, warm_cold) %>%
  summarise(
    estimates = n(),
    studies = n_distinct(ref)
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = pop_size, 
                      y = lnCVR, 
                      size = 1/sqrt(var_lnCVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_pop_size, # Shaded area for credible intervals
                 aes(x = pop_size,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_pop_size, # Predicted regression line
               aes(y = emmean,
                   x = pop_size,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes_pop_size, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Population size", y = "lnCVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3, 3))

ggsave(file = "fig/lnCVR_pop_size.png", width = 12, height = 7, dpi = 500)
```


### **All moderators** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnCVR ~ 0 + trait_type:warm_cold + 
                trait_type:warm_cold:assay_temp_diff + 
                trait_type:warm_cold:scale(select_temp_diff) +
                trait_type:warm_cold:scale(gen_selection) + 
                trait_type:warm_cold:scale(gen_common_garden) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnCVR_model_all_moderators <- brm(formula, 
                                  family = gaussian(),
                                  data = data, 
                                  data2 = list(phylo_matrix = phylo_matrix,
                                               VCV_lnCVR = VCV_lnCVR),
                                  prior = prior,
                                  control = list(adapt_delta = 0.99, max_treedepth = 15),
                                  iter = 4000, 
                                  warmup = 2000,
                                  chains = 4, 
                                  cores = 4, 
                                  seed = 123) 

# Save model
saveRDS(lnCVR_model_all_moderators, file = "RData/lnCVR_model_all_moderators.rds")
```

#### *Model output*
```{r}
# Load model
lnCVR_model_all_moderators <- readRDS("RData/lnCVR_model_all_moderators.rds")

# Display model output 
summary(lnCVR_model_all_moderators)

# Cleaned model output
as.data.frame(fixef(lnCVR_model_all_moderators, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from all moderator variables
    Parameter = gsub("scale", "", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)

# Generate predicted values at different assay temperatures
emmeans_full_model <- as.data.frame(emmeans(
  lnCVR_model_all_moderators,
  specs = ~ assay_temp_diff * select_temp_diff * gen_selection * gen_common_garden | trait_type * warm_cold,
  at = list(assay_temp_diff = c(-8.5, -4, 0, 4, 5, -5, 17, 20)) # Predict at unique min, control, max values
))

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay = min(assay_temp_diff),
    max_assay = max(assay_temp_diff),
    control_assay = 0
  )

emmeans_full_model$trait_type <- factor(emmeans_full_model$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_full_model$warm_cold <- factor(emmeans_full_model$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_full_model %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff == min_assay |
    assay_temp_diff == max_assay |
    assay_temp_diff == control_assay) %>% 
    dplyr::select(-min_assay, -max_assay, -control_assay) %>% 
    mutate(percentage_change = (exp(emmean) - 1) * 100,
           percentage_lower_HPD = (exp(lower.HPD) - 1) * 100,
           percentage_upper_HPD = (exp(upper.HPD) - 1) * 100) %>%
  mutate(across(c(emmean, 
                  lower.HPD, 
                  upper.HPD, 
                  percentage_change,
                  percentage_lower_HPD, 
                  percentage_upper_HPD), ~ round(., 3))) %>%   # Round numbers to 3 decimal points
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

**Marginal means** 
```{r, fig.width = 12, fig.height=10}
# Generate predictions at assay_temp_diff = 0, or 5 degrees below or above the control temperatures
emmeans_full_model <- as.data.frame(emmeans(
  lnCVR_model_all_moderators,
  specs = ~ assay_temp_diff * select_temp_diff * gen_selection * gen_common_garden | trait_type * warm_cold,
  at = list(assay_temp_diff = c(-5, 0, 5) # Re-acclimated to control, or 5 degrees above/below the contol
  ))) 

# Rename variable levels
emmeans_full_model$trait_type <- factor(emmeans_full_model$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_full_model$warm_cold <- factor(emmeans_full_model$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))
emmeans_full_model

# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_quasirandom(data = data,     # Plot effect sizes, scaled by precision
                     aes(x = trait_type:warm_cold, 
                         y = lnCVR, 
                         fill = trait_type:warm_cold, 
                         size = 1/sqrt(var_lnCVR)), 
                     color = "black",
                     shape = 21,
                     width = 0.3, 
                     alpha = 0.3) +
    geom_errorbar(data = filter(emmeans_full_model,
                                assay_temp_diff == "-5"),  # 5 degrees below control (background)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.75,
                  width = 0.16,
               position = position_nudge(x=-0.25)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "-5"),  # 5 degrees below control (background)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 21,
               size = 4.5, 
               stroke = 2,
               color="white",
               fill = "white",
               position = position_nudge(x=-0.25)) +
    geom_errorbar(data = filter(emmeans_full_model,
                             assay_temp_diff == "-5"), # 5 degrees below control (credible intervals)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="#06B4BA",
                  size = 2,
                  width = 0.12,
               position = position_nudge(x=-0.25)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "-5"), # 5 degrees below control  (point estimates)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 21,
               size = 3.5, 
               stroke = 2,
               color="#06B4BA",
               fill = "white",
               position = position_nudge(x=-0.25)) +

      geom_errorbar(data = filter(emmeans_full_model,
                                assay_temp_diff == "0"),  # control temperature (background)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.75,
                  width = 0.16,
               position = position_nudge(x=0)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "0"),  # control temperature (background)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 22,
               size = 4.5, 
               stroke = 2,
               color="white",
               fill = "white",
               position = position_nudge(x=0)) +
    geom_errorbar(data = filter(emmeans_full_model,
                             assay_temp_diff == "0"), # control temperature (credible intervals)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="black",
                  size = 2,
                  width = 0.12,
               position = position_nudge(x=0)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "0"), # control temperature (point estimates)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 22,
               size = 3.5, 
               stroke = 2,
               color="black",
               fill = "white",
               position = position_nudge(x=0)) +
  
      geom_errorbar(data = filter(emmeans_full_model,
                                assay_temp_diff == "5"),  # 5 degrees above control (background)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.75,
                  width = 0.16,
               position = position_nudge(x=0.25)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "5"),  # 5 degrees above control (background)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 23,
               size = 4.5, 
               stroke = 2,
               color="white",
               fill = "white",
               position = position_nudge(x=0.25)) +
    geom_errorbar(data = filter(emmeans_full_model,
                             assay_temp_diff == "5"), # 5 degrees above control (credible intervals)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="#E80756",
                  size = 2,
                  width = 0.12,
               position = position_nudge(x=0.25)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "5"), # 5 degrees above control (point estimates)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 23,
               size = 3.5, 
               stroke = 2,
               color="#E80756",
               fill = "white",
               position = position_nudge(x=0.25)) +
  
    geom_text(data = sample_sizes,  # Sample size annotations 
              aes(x = trait_type:warm_cold, 
                  y = 3,
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1, size = 5, show.legend = FALSE) +
  
    theme_bw() +     # Customize the plot
    labs(y = "lnCVR", x = "") +
    scale_size_continuous(range = c(2, 8))+ 
    scale_fill_manual(values = c("#06B4BA", "#E80756", "#06B4BA", "#E80756", "#06B4BA", "#E80756"))+
    scale_color_manual(values = c("Cold" = "#06B4BA", "Warm" = "#E80756")) +  # Text colour
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5)) +
    guides(fill = "none", size = "none")+
    coord_flip() + 
    ylim(-3, 3)

ggsave(file = "fig/lnCVR_all_moderators_marginal_means.png", width = 12, height = 8, dpi = 500)
```

**Overall trend with assay temperature** 
```{r, fig.width = 12, fig.height=10}
# Generate predictions for all assay temperatures
emmeans_full_model_assay <- as.data.frame(emmeans(
  lnCVR_model_all_moderators,
  specs = ~ assay_temp_diff * select_temp_diff * gen_selection * gen_common_garden | trait_type * warm_cold,
  at = list(assay_temp_diff = seq(min(data$assay_temp_diff), max(data$assay_temp_diff), by = 0.5) # Re-acclimated to control, or 5 degrees above/below the contol
  ))) 

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

# Rename variable levels
emmeans_full_model_assay$trait_type <- factor(emmeans_full_model_assay$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_full_model_assay$warm_cold <- factor(emmeans_full_model_assay$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_full_model_assay <- emmeans_full_model_assay %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )


# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnCVR, 
                      size = 1/sqrt(var_lnCVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_full_model_assay, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_full_model_assay,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
  
    geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnCVR",
       col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3, 3))

ggsave(file = "fig/lnCVR_all_moderators_assay_temp_diff.png", width = 12, height = 10, dpi = 500)
```


## **Changes in trait variance (lnVR)** {.tabset .tabset_fade .tabset_pills}

### **Overall model**

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnVR ~ trait_type -1 + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnVR_model_overall <- brm(formula, 
                           family = gaussian(),
                           data = data, 
                           data2 = list(phylo_matrix = phylo_matrix,
                                        VCV_lnVR = VCV_lnVR),
                           prior = prior,
                           control = list(adapt_delta = 0.99, max_treedepth = 15),
                           iter = 4000, 
                           warmup = 2000,
                           chains = 4, 
                           cores = 4, 
                           seed = 123) 

# Save model
saveRDS(lnVR_model_overall, file = "RData/lnVR_model_overall.rds")
```

#### *Model output*
```{r}
# Load model
lnVR_model_overall <- readRDS("RData/lnVR_model_overall.rds")

# Display model output 
summary(lnVR_model_overall)

# Cleaned model output
as.data.frame(fixef(lnVR_model_overall, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+)", "\\1", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Heterogeneity analysis*
```{r}
# Extracting the posterior distribution from the model
posterior <- posterior_samples(lnVR_model_overall)

# Calculate measurement error variance
sigma2_v <- sum(1/diag(VCV_lnVR)) * (length(diag(VCV_lnVR))- 1)/(sum(1/diag(VCV_lnVR))^2 - sum((1/diag(VCV_lnVR))^2))

# Calculate the total variance (including the measurement error variance)
var_total <- posterior$sd_experiment_ID__Intercept +
             posterior$sd_obs__Intercept +
             posterior$sd_phylogeny__Intercept +
             posterior$sd_ref__trait_typebody_size +
             posterior$sd_ref__trait_typefecundity +
             posterior$sd_ref__trait_typesurvival +
             posterior$sd_species__Intercept +
             sigma2_v

# Calculate heterogeneity (I2)
I2 <- list(
    I2_total = (var_total - sigma2_v) / var_total, # Total heterogeneity
    I2_study = (posterior$sd_ref__trait_typebody_size + # Heterogeneity explained by study differences
                posterior$sd_ref__trait_typefecundity +
                posterior$sd_ref__trait_typesurvival) / var_total,
    I2_exp = posterior$sd_experiment_ID__Intercept / var_total, # Heterogeneity explained by experiment differences
    I2_sp = posterior$sd_species__Intercept / var_total, # Heterogeneity explained by species differences
    I2_phylo = posterior$sd_phylogeny__Intercept / var_total, # Heterogeneity explained by phylogenetic relatedness
    I2_obs = posterior$sd_obs__Intercept / var_total # Heterogeneity explained by residual variation

)

# Calculate mean and credible intervals 
summary_table <- t(sapply(I2, function(x) {
    c(Mean = 100*round(mean(x),4), 
      ` ` = 100* round(quantile(x, 0.025),4), 
      ` ` = 100*round(quantile(x, 0.975),4))
}))

# Customise table
summary_table <- summary_table %>%
    as.data.frame() %>% 
    rownames_to_column("Variable") %>%
    mutate(
        Variable = recode(Variable,
                          "I2_total"  = "Total",
                          "I2_study"  = "Study",
                          "I2_exp"    = "Experiment",
                          "I2_sp"     = "Species",
                          "I2_phylo"  = "Phylogeny",
                          "I2_obs"    = "Residual")
    ) %>%
    rename(
        lower_HPD = ` .2.5%`,
        upper_HPD = ` .97.5%`
    ) %>%
  mutate(
    Variable = paste0("I<sup>2</sup><sub>", Variable)   # Create a new column with formatted I² and subscripts
  )


# Display table
kable(summary_table, "html", escape = FALSE, 
      col.names = c("Heterogeneity (%)", "Mean", "Lower HPD", "Upper HPD"),
      align = c('l', 'r', 'r', 'r')) %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, width = "200px", bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)

```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=7}
# Generate predictions
emmeans_overall <- as.data.frame(emmeans(lnVR_model_overall, ~ trait_type))

emmeans_overall$trait_type <- factor(emmeans_overall$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))
# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_quasirandom(data = data, # Plot effect sizes, scaled by precision
                     aes(x = trait_type, 
                         y = lnVR, 
                         size = 1/sqrt(var_lnVR)), 
                     fill = "gray75",
                     shape = 21,
                     width = 0.25, 
                     alpha = 0.2) +
    geom_errorbar(data = emmeans_overall,   # Plot the point estimates in white for background
                  aes(ymin = lower.HPD, 
                      ymax = upper.HPD,
                      x = trait_type), 
                  size = 2,
                  width = 0.085,
                  color = "white") +
    geom_point(data = emmeans_overall, # Plot the credible intervals in white for background
               aes(x = trait_type, 
                   y = emmean),
               size = 4.5, 
               stroke = 1.5,
               shape = 21,
               color="white",
               fill = "white") +
    geom_errorbar(data = emmeans_overall,  # Plot the point estimates 
                  aes(x = trait_type, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  size = 1.5,
                  width = 0.075,
                  color = "black") +
    geom_point(data = emmeans_overall, # Plot the credible intervals
               aes(x = trait_type, 
                   y = emmean),
               size = 4,
               shape = 21,
               stroke = 1.5,
               color="black",
               fill = "white") +
    geom_text(data = sample_sizes_traits,  # Sample size annotations 
              aes(x = trait_type, 
                  y = 3.5,
                  label = paste0("k = ", estimates, " (", studies, ")")), 
              hjust = 1, size = 5, show.legend = FALSE) +
    theme_bw() +     # Customize the plot
    labs(y = "lnVR", x = "") +
    scale_size_continuous(range = c(2, 8))+ 
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5)) +
    guides(color = "none", size = "none")+
    coord_flip() + 
    ylim(-3.5, 3.5)

# Save figure
ggsave(file = "fig/lnVR_overall.png", width = 12, height = 7, dpi = 500)
```

### **Temperature regime** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnVR ~ trait_type:warm_cold -1 + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnVR_model_warm_cold <- brm(formula, 
                  family = gaussian(),
                  data = data, 
                  data2 = list(phylo_matrix = phylo_matrix,
                               VCV_lnVR = VCV_lnVR),
                  prior = prior,
                  control = list(adapt_delta = 0.99, max_treedepth = 15),
                  iter = 4000, 
                  warmup = 2000,
                  chains = 4, 
                  cores = 4, 
                  seed = 123) 

# Save model
saveRDS(lnVR_model_warm_cold, file = "RData/lnVR_model_warm_cold.rds")
```

#### *Model output*
```{r}
# Load model
lnVR_model_warm_cold <- readRDS("RData/lnVR_model_warm_cold.rds")

# Display model output 
summary(lnVR_model_warm_cold)

# Cleaned model output
as.data.frame(fixef(lnVR_model_warm_cold, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Contrasts* 
```{r}
# Generate predictions
emms <- emmeans(lnVR_model_warm_cold, 
                specs = ~ warm_cold | trait_type)

# Generate contrasts
contrast(emms, method = "pairwise")
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=7}
# Generate predictions
emmeans_warm_cold <- as.data.frame(emmeans(lnVR_model_warm_cold, 
                                           specs = ~ warm_cold | trait_type))

emmeans_warm_cold$trait_type <- factor(emmeans_warm_cold$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_warm_cold$warm_cold <- factor(emmeans_warm_cold$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))
# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_quasirandom(data = data,     # Plot effect sizes, scaled by precision
                     aes(x = trait_type:warm_cold, 
                         y = lnVR, 
                         fill = trait_type:warm_cold, 
                         size = 1/sqrt(var_lnVR)), 
                     color = "black",
                     shape = 21,
                     width = 0.25, 
                     alpha = 0.3) +
    geom_errorbar(data = emmeans_warm_cold,  # Plot the point estimates in white for background
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.5,
                  width = 0.17) +
    geom_point(data = emmeans_warm_cold,  # Plot the credible intervals in white for background
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 21,
               size = 4, 
               stroke = 2,
               color="white",
               fill = "white") +
    geom_errorbar(data = emmeans_warm_cold, # Plot the point estimates 
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="black",
                  size = 2,
                  width = 0.15) +
    geom_point(data = emmeans_warm_cold, # Plot the credible intervals
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 21,
               size = 3.5, 
               stroke = 2,
               color="black",
               fill = "white") +
    geom_text(data = sample_sizes,  # Sample size annotations 
              aes(x = trait_type:warm_cold, 
                  y = 3.5,
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1, size = 5, show.legend = FALSE) +
    theme_bw() +     # Customize the plot
    labs(y = "lnVR", x = "") +
    scale_size_continuous(range = c(2, 8))+ 
#    scale_fill_manual(values = c("#A5F820", "#73B706",  "#9CEFFC", "#06A2BA",  "#FED2ED", "#B90674"))+
    scale_fill_manual(values = c("#06B4BA", "#E80756", "#06B4BA", "#E80756", "#06B4BA", "#E80756"))+
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5)) +
    guides(fill = "none", size = "none")+
    coord_flip() + 
    ylim(-3.5, 3.5)

ggsave(file = "fig/lnVR_warm_cold.png", width = 12, height = 7, dpi = 500)
```

### **Assay temperature difference** 

We calculated the difference between the assay temperature and control temperature (assay_temp_diff) to account for the fact that animals were tested to a different range of temperatures. We also predicted that effects will vary if traits are assayed at colder- or warmer-than-control conditions, depending on the temperature regime. 
Because the variation in assay temperature generates some nuisance heterogeneity (sensu Noble et al., 2017), the results of subsequent models were provided after controlling for assay temperature differences. In order words, the results of all moderators are conditional on assay temperature, meaning that results are interpretable as the difference between control and selected lines, when animals are tested at the control temperature. 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnVR ~ 0 + trait_type:warm_cold + trait_type:warm_cold:assay_temp_diff + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnVR_model_assay_temp_diff <- brm(formula, 
                                  family = gaussian(),
                                  data = data, 
                                  data2 = list(phylo_matrix = phylo_matrix,
                                               VCV_lnVR = VCV_lnVR),
                                  prior = prior,
                                  control = list(adapt_delta = 0.99, max_treedepth = 15),
                                  iter = 4000, 
                                  warmup = 2000,
                                  chains = 4, 
                                  cores = 4, 
                                  seed = 123) 

# Save model
saveRDS(lnVR_model_assay_temp_diff, file = "RData/lnVR_model_assay_temp_diff.rds")
```

#### *Model output*
```{r}
# Load model
lnVR_model_assay_temp_diff <- readRDS("RData/lnVR_model_assay_temp_diff.rds")

# Display model output 
summary(lnVR_model_assay_temp_diff)

# Cleaned model output
as.data.frame(fixef(lnVR_model_assay_temp_diff, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    Parameter = gsub("trait_type([a-z_]+)\\(warm\\):assay_temp_diff", "\\1(warm): assay_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_assay_temp_diff <- as.data.frame(emmeans(
  lnVR_model_assay_temp_diff,
  specs = ~ assay_temp_diff | trait_type * warm_cold,
  at = list(assay_temp_diff = seq(min(data$assay_temp_diff), max(data$assay_temp_diff), by = 0.5)))
  )

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

emmeans_assay_temp_diff$trait_type <- factor(emmeans_assay_temp_diff$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_assay_temp_diff$warm_cold <- factor(emmeans_assay_temp_diff$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_assay_temp_diff <- emmeans_assay_temp_diff %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_assay_temp_diff, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_assay_temp_diff,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
    geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnVR",
       col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5))

ggsave(file = "fig/lnVR_assay_temp_diff.png", width = 12, height = 10, dpi = 500)
```

### **Selection temperature** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnVR ~ 0 + trait_type:warm_cold + 
                          trait_type:warm_cold:assay_temp_diff + 
                          trait_type:warm_cold:select_temp_diff + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnVR_model_sel_temp_diff <- brm(formula, 
                                family = gaussian(),
                                data = data, 
                                data2 = list(phylo_matrix = phylo_matrix,
                                             VCV_lnVR = VCV_lnVR),
                                prior = prior,
                                control = list(adapt_delta = 0.99, max_treedepth = 15),
                                iter = 4000, 
                                warmup = 2000,
                                chains = 4, 
                                cores = 4, 
                                seed = 123) 

# Save model
saveRDS(lnVR_model_sel_temp_diff, file = "RData/lnVR_model_sel_temp_diff.rds")
```

#### *Model output*
```{r}
# Load model
lnVR_model_sel_temp_diff <- readRDS("RData/lnVR_model_sel_temp_diff.rds")

# Display model output 
summary(lnVR_model_sel_temp_diff)

# Cleaned model output
as.data.frame(fixef(lnVR_model_sel_temp_diff, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    Parameter = gsub("trait_type([a-z_]+)\\(warm\\):select_temp_diff", "\\1(warm): select_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_sel_temp_diff <- as.data.frame(emmeans(
  lnVR_model_sel_temp_diff,
  specs = ~ select_temp_diff | trait_type * warm_cold,
  at = list(select_temp_diff = seq(min(data$select_temp_diff), max(data$select_temp_diff), by = 0.5),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_select_temp_diff = min(select_temp_diff),
    max_select_temp_diff = max(select_temp_diff)
  )

emmeans_sel_temp_diff$trait_type <- factor(emmeans_sel_temp_diff$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_sel_temp_diff$warm_cold <- factor(emmeans_sel_temp_diff$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_sel_temp_diff <- emmeans_sel_temp_diff %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    select_temp_diff >= min_select_temp_diff,
    select_temp_diff <= max_select_temp_diff
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = select_temp_diff, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_sel_temp_diff, # Shaded area for credible intervals
                 aes(x = select_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_sel_temp_diff, # Predicted regression line
               aes(y = emmean,
                   x = select_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Selection temperature difference", y = "lnVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5))

ggsave(file = "fig/lnVR_sel_temp_diff.png", width = 12, height = 7, dpi = 500)
```

### **Number of generations of selection** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnVR ~ 0 + trait_type:warm_cold + 
                          trait_type:warm_cold:assay_temp_diff + 
                          trait_type:warm_cold:scale(gen_selection) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnVR_model_gen_selection <- brm(formula, 
                                family = gaussian(),
                                data = data, 
                                data2 = list(phylo_matrix = phylo_matrix,
                                             VCV_lnVR = VCV_lnVR),
                                prior = prior,
                                control = list(adapt_delta = 0.99, max_treedepth = 15),
                                iter = 4000, 
                                warmup = 2000,
                                chains = 4, 
                                cores = 4, 
                                seed = 123) 
# Save model
saveRDS(lnVR_model_gen_selection, file = "RData/lnVR_model_gen_selection.rds")
```

#### *Model output*
```{r}
# Load model
lnVR_model_gen_selection <- readRDS("RData/lnVR_model_gen_selection.rds")

# Display model output 
summary(lnVR_model_gen_selection)

# Cleaned model output
as.data.frame(fixef(lnVR_model_gen_selection, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from gen_selection
    Parameter = gsub("scalegen_selection", "gen_selection", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=7}

# Generate predictions
emmeans_gen_selection <- as.data.frame(emmeans(
  lnVR_model_gen_selection,
  specs = ~ gen_selection | trait_type * warm_cold,
  at = list(gen_selection = seq(min(data$gen_selection), max(data$gen_selection), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_gen_selection = min(gen_selection),
    max_gen_selection = max(gen_selection)
  )

emmeans_gen_selection$trait_type <- factor(emmeans_gen_selection$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_gen_selection$warm_cold <- factor(emmeans_gen_selection$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_gen_selection <- emmeans_gen_selection %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    gen_selection >= min_gen_selection,
    gen_selection <= max_gen_selection
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = gen_selection, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_gen_selection, # Shaded area for credible intervals
                 aes(x = gen_selection,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_gen_selection, # Predicted regression line
               aes(y = emmean,
                   x = gen_selection,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Number of generations of selection", y = "lnVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5),
                    xlim = c(0, 150))

ggsave(file = "fig/lnVR_gen_selection.png", width = 12, height = 7, dpi = 500)
```

### **Number of generations of common garden** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnVR ~ 0 + trait_type:warm_cold + 
                          trait_type:warm_cold:assay_temp_diff + 
                          trait_type:warm_cold:scale(gen_common_garden) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnVR_model_gen_common_garden <- brm(formula, 
                                family = gaussian(),
                                data = data, 
                                data2 = list(phylo_matrix = phylo_matrix,
                                             VCV_lnVR = VCV_lnVR),
                                prior = prior,
                                control = list(adapt_delta = 0.99, max_treedepth = 15),
                                iter = 4000, 
                                warmup = 2000,
                                chains = 4, 
                                cores = 4, 
                                seed = 123) 
# Save model
saveRDS(lnVR_model_gen_common_garden, file = "RData/lnVR_model_gen_common_garden.rds")
```

#### *Model output*
```{r}
# Load model
lnVR_model_gen_common_garden <- readRDS("RData/lnVR_model_gen_common_garden.rds")

# Display model output 
summary(lnVR_model_gen_common_garden)

# Cleaned model output
as.data.frame(fixef(lnVR_model_gen_common_garden, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from gen_selection
    Parameter = gsub("scalegen_common_garden", "gen_common_garden", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=10}

# Generate predictions
emmeans_gen_common_garden <- as.data.frame(emmeans(
  lnVR_model_gen_common_garden,
  specs = ~ gen_common_garden | trait_type * warm_cold,
  at = list(gen_common_garden = seq(min(data$gen_common_garden), max(data$gen_common_garden), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_gen_common_garden = min(gen_common_garden),
    max_gen_common_garden = max(gen_common_garden)
  )

emmeans_gen_common_garden$trait_type <- factor(emmeans_gen_common_garden$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_gen_common_garden$warm_cold <- factor(emmeans_gen_common_garden$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_gen_common_garden <- emmeans_gen_common_garden %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    gen_common_garden >= min_gen_common_garden,
    gen_common_garden <= max_gen_common_garden
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = gen_common_garden, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_gen_common_garden, # Shaded area for credible intervals
                 aes(x = gen_common_garden,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_gen_common_garden, # Predicted regression line
               aes(y = emmean,
                   x = gen_common_garden,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Number of generations of common garden", y = "lnVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5),
                    xlim = c(0, 12))

ggsave(file = "fig/lnVR_gen_common_garden.png", width = 12, height = 7, dpi = 500)
```

### **Population size** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnVR ~ 0 + trait_type:warm_cold + 
                          trait_type:warm_cold:assay_temp_diff + 
                          trait_type:warm_cold:scale(pop_size) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnVR_model_pop_size <- brm(formula, 
                                family = gaussian(),
                                data = data, 
                                data2 = list(phylo_matrix = phylo_matrix,
                                             VCV_lnVR = VCV_lnVR),
                                prior = prior,
                                control = list(adapt_delta = 0.99, max_treedepth = 15),
                                iter = 4000, 
                                warmup = 2000,
                                chains = 4, 
                                cores = 4, 
                                seed = 123) 
# Save model
saveRDS(lnVR_model_pop_size, file = "RData/lnVR_model_pop_size.rds")
```

#### *Model output*
```{r}
# Load model
lnVR_model_pop_size <- readRDS("RData/lnVR_model_pop_size.rds")

# Display model output 
summary(lnVR_model_pop_size)

# Cleaned model output
as.data.frame(fixef(lnVR_model_pop_size, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from pop_size
    Parameter = gsub("scalepop_size", "pop_size", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=10}

# Generate predictions
emmeans_pop_size <- as.data.frame(emmeans(
  lnVR_model_pop_size,
  specs = ~ pop_size | trait_type * warm_cold,
  at = list(pop_size = seq(min(data$pop_size, na.rm=T), max(data$pop_size, na.rm=T), by = 50),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_pop_size = min(pop_size, na.rm=T),
    max_pop_size = max(pop_size, na.rm=T)
  )

emmeans_pop_size$trait_type <- factor(emmeans_pop_size$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_pop_size$warm_cold <- factor(emmeans_pop_size$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_pop_size <- emmeans_pop_size %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    pop_size >= min_pop_size,
    pop_size <= max_pop_size
  )

# Calculate sample sizes and study counts for population size
sample_sizes_pop_size <- data %>%
  filter(is.na(pop_size)==FALSE) %>% 
  group_by(trait_type, warm_cold) %>%
  summarise(
    estimates = n(),
    studies = n_distinct(ref)
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = pop_size, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_pop_size, # Shaded area for credible intervals
                 aes(x = pop_size,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_pop_size, # Predicted regression line
               aes(y = emmean,
                   x = pop_size,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes_pop_size, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Population size", y = "lnVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    ylim(-3.5, 3.5)

ggsave(file = "fig/lnVR_pop_size.png", width = 12, height = 7, dpi = 500)
```

### **All moderators** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnVR ~ 0 + trait_type:warm_cold + 
                trait_type:warm_cold:assay_temp_diff + 
                trait_type:warm_cold:scale(select_temp_diff) +
                trait_type:warm_cold:scale(gen_selection) + 
                trait_type:warm_cold:scale(gen_common_garden) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnVR_model_all_moderators <- brm(formula, 
                                  family = gaussian(),
                                  data = data, 
                                  data2 = list(phylo_matrix = phylo_matrix,
                                               VCV_lnVR = VCV_lnVR),
                                  prior = prior,
                                  control = list(adapt_delta = 0.99, max_treedepth = 15),
                                  iter = 4000, 
                                  warmup = 2000,
                                  chains = 4, 
                                  cores = 4, 
                                  seed = 123) 

# Save model
saveRDS(lnVR_model_all_moderators, file = "RData/lnVR_model_all_moderators.rds")
```

#### *Model output*
```{r}
# Load model
lnVR_model_all_moderators <- readRDS("RData/lnVR_model_all_moderators.rds")

# Display model output 
summary(lnVR_model_all_moderators)

# Cleaned model output
as.data.frame(fixef(lnVR_model_all_moderators, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from all moderator variables
    Parameter = gsub("scale", "", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)


# Generate predicted values at different assay temperatures
emmeans_full_model <- as.data.frame(emmeans(
  lnVR_model_all_moderators,
  specs = ~ assay_temp_diff * select_temp_diff * gen_selection * gen_common_garden | trait_type * warm_cold,
  at = list(assay_temp_diff = c(-8.5, -4, 0, 4, 5, -5, 17, 20)) # Predict at unique min, control, max values
))

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay = min(assay_temp_diff),
    max_assay = max(assay_temp_diff),
    control_assay = 0
  )

emmeans_full_model$trait_type <- factor(emmeans_full_model$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_full_model$warm_cold <- factor(emmeans_full_model$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_full_model %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff == min_assay |
    assay_temp_diff == max_assay |
    assay_temp_diff == control_assay) %>% 
    dplyr::select(-min_assay, -max_assay, -control_assay) %>% 
    mutate(percentage_change = (exp(emmean) - 1) * 100,
           percentage_lower_HPD = (exp(lower.HPD) - 1) * 100,
           percentage_upper_HPD = (exp(upper.HPD) - 1) * 100) %>%
  mutate(across(c(emmean, 
                  lower.HPD, 
                  upper.HPD, 
                  percentage_change,
                  percentage_lower_HPD, 
                  percentage_upper_HPD), ~ round(., 3))) %>%   # Round numbers to 3 decimal points
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)

```

#### *Data visualisation*

**Marginal means** 
```{r, fig.width = 12, fig.height=10}
# Generate predictions at assay_temp_diff = 0, or 5 degrees below or above the control temperatures
emmeans_full_model <- as.data.frame(emmeans(
  lnVR_model_all_moderators,
  specs = ~ assay_temp_diff * select_temp_diff * gen_selection * gen_common_garden | trait_type * warm_cold,
  at = list(assay_temp_diff = c(-5, 0, 5) # Re-acclimated to control, or 5 degrees above/below the contol
  ))) # 2 generations of common garden

# Rename variable levels
emmeans_full_model$trait_type <- factor(emmeans_full_model$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_full_model$warm_cold <- factor(emmeans_full_model$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))
emmeans_full_model

# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_quasirandom(data = data,     # Plot effect sizes, scaled by precision
                     aes(x = trait_type:warm_cold, 
                         y = lnVR, 
                         fill = trait_type:warm_cold, 
                         size = 1/sqrt(var_lnVR)), 
                     color = "black",
                     shape = 21,
                     width = 0.3, 
                     alpha = 0.3) +
    geom_errorbar(data = filter(emmeans_full_model,
                                assay_temp_diff == "-5"),  # 5 degrees below control (background)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.75,
                  width = 0.16,
               position = position_nudge(x=-0.25)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "-5"),  # 5 degrees below control (background)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 21,
               size = 4.5, 
               stroke = 2,
               color="white",
               fill = "white",
               position = position_nudge(x=-0.25)) +
    geom_errorbar(data = filter(emmeans_full_model,
                             assay_temp_diff == "-5"), # 5 degrees below control (credible intervals)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="#06B4BA",
                  size = 2,
                  width = 0.12,
               position = position_nudge(x=-0.25)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "-5"), # 5 degrees below control  (point estimates)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 21,
               size = 3.5, 
               stroke = 2,
               color="#06B4BA",
               fill = "white",
               position = position_nudge(x=-0.25)) +

      geom_errorbar(data = filter(emmeans_full_model,
                                assay_temp_diff == "0"),  # control temperature (background)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.75,
                  width = 0.16,
               position = position_nudge(x=0)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "0"),  # control temperature (background)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 22,
               size = 4.5, 
               stroke = 2,
               color="white",
               fill = "white",
               position = position_nudge(x=0)) +
    geom_errorbar(data = filter(emmeans_full_model,
                             assay_temp_diff == "0"), # control temperature (credible intervals)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="black",
                  size = 2,
                  width = 0.12,
               position = position_nudge(x=0)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "0"), # control temperature (point estimates)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 22,
               size = 3.5, 
               stroke = 2,
               color="black",
               fill = "white",
               position = position_nudge(x=0)) +
  
      geom_errorbar(data = filter(emmeans_full_model,
                                assay_temp_diff == "5"),  # 5 degrees above control (background)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.75,
                  width = 0.16,
               position = position_nudge(x=0.25)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "5"),  # 5 degrees above control (background)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 23,
               size = 4.5, 
               stroke = 2,
               color="white",
               fill = "white",
               position = position_nudge(x=0.25)) +
    geom_errorbar(data = filter(emmeans_full_model,
                             assay_temp_diff == "5"), # 5 degrees above control (credible intervals)
                  aes(x = trait_type:warm_cold, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="#E80756",
                  size = 2,
                  width = 0.12,
               position = position_nudge(x=0.25)) +
    geom_point(data = filter(emmeans_full_model,
                             assay_temp_diff == "5"), # 5 degrees above control (point estimates)
               aes(x = trait_type:warm_cold, 
                   y = emmean),
               shape = 23,
               size = 3.5, 
               stroke = 2,
               color="#E80756",
               fill = "white",
               position = position_nudge(x=0.25)) +
  
    geom_text(data = sample_sizes,  # Sample size annotations 
              aes(x = trait_type:warm_cold, 
                  y = 3,
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1, size = 5, show.legend = FALSE) +
  
    theme_bw() +     # Customize the plot
    labs(y = "lnVR", x = "") +
    scale_size_continuous(range = c(2, 8))+ 
    scale_fill_manual(values = c("#06B4BA", "#E80756", "#06B4BA", "#E80756", "#06B4BA", "#E80756"))+
    scale_color_manual(values = c("Cold" = "#06B4BA", "Warm" = "#E80756")) +  # Text colour
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5)) +
    guides(fill = "none", size = "none")+
    coord_flip() + 
    ylim(-3.5, 3.5)

ggsave(file = "fig/lnVR_all_moderators_marginal_means.png", width = 12, height = 8, dpi = 500)
```

**Overall trend with assay temperature** 
```{r, fig.width = 12, fig.height=10}
# Generate predictions for all assay temperatures
emmeans_full_model_assay <- as.data.frame(emmeans(
  lnVR_model_all_moderators,
  specs = ~ assay_temp_diff * select_temp_diff * gen_selection * gen_common_garden | trait_type * warm_cold,
  at = list(assay_temp_diff = seq(min(data$assay_temp_diff), max(data$assay_temp_diff), by = 0.5) # Re-acclimated to control, or 5 degrees above/below the contol
  ))) 


# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

# Rename variable levels
emmeans_full_model_assay$trait_type <- factor(emmeans_full_model_assay$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_full_model_assay$warm_cold <- factor(emmeans_full_model_assay$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_full_model_assay <- emmeans_full_model_assay %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )


# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_full_model_assay, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_full_model_assay,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
  
    geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnVR",
       col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5))

ggsave(file = "fig/lnVR_all_moderators_assay_temp_diff.png", width = 12, height = 10, dpi = 500)
```



# **Publication bias** 

## **Changes in mean responses (lnRR)** {.tabset .tabset_fade .tabset_pills}

### **Egger's regression** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnRR ~ 0 + trait_type:warm_cold + 
                         trait_type:warm_cold:assay_temp_diff + 
                         trait_type:warm_cold:var_lnRR + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnRR_model_pub_bias_var <- brm(formula, 
                                            family = gaussian(),
                                            data = data, 
                                            data2 = list(phylo_matrix = phylo_matrix,
                                                         VCV_lnRR = VCV_lnRR),
                                            prior = prior,
                                            control = list(adapt_delta = 0.99, max_treedepth = 15),
                                            iter = 4000, 
                                            warmup = 2000,
                                            chains = 4, 
                                            cores = 4, 
                                            seed = 123) 
# Save model
saveRDS(lnRR_model_pub_bias_var, file = "RData/lnRR_model_pub_bias_var.rds")
```

#### *Model output*
```{r}
# Load model
lnRR_model_pub_bias_var <- readRDS("RData/lnRR_model_pub_bias_var.rds")

# Display model output 
summary(lnRR_model_pub_bias_var)

# Cleaned model output
as.data.frame(fixef(lnRR_model_pub_bias_var, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    Parameter = gsub("trait_type([a-z_]+)\\(warm\\):assay_temp_diff", "\\1(warm): assay_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_pub_bias_var <- as.data.frame(emmeans(
  lnRR_model_pub_bias_var,
  specs = ~ var_lnRR | trait_type * warm_cold,
  at = list(var_lnRR = seq(0, max(data$var_lnRR), by = 0.1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

emmeans_pub_bias_var$trait_type <- factor(emmeans_pub_bias_var$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_pub_bias_var$warm_cold <- factor(emmeans_pub_bias_var$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = var_lnRR, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.001)) + 
     geom_ribbon(data = emmeans_pub_bias_var, # Shaded area for credible intervals
                 aes(x = var_lnRR,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_pub_bias_var, # Predicted regression line
               aes(y = emmean,
                   x = var_lnRR,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.8, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Sampling variance of lnRR", y = "lnRR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-1.5, 1.5), xlim = c(0, 0.3))

ggsave(file = "fig/lnRR_pub_bias_var.png", width = 12, height = 7, dpi = 500)
```

### **Publication year** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnRR ~ 0 + trait_type:warm_cold + 
                         trait_type:warm_cold:assay_temp_diff + 
                         trait_type:warm_cold:scale(pub_year) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnRR_model_pub_bias_year <- brm(formula, 
                                            family = gaussian(),
                                            data = data, 
                                            data2 = list(phylo_matrix = phylo_matrix,
                                                         VCV_lnRR = VCV_lnRR),
                                            prior = prior,
                                            control = list(adapt_delta = 0.99, max_treedepth = 15),
                                            iter = 4000, 
                                            warmup = 2000,
                                            chains = 4, 
                                            cores = 4, 
                                            seed = 123) 
# Save model
saveRDS(lnRR_model_pub_bias_year, file = "RData/lnRR_model_pub_bias_year.rds")
```

#### *Model output*
```{r}
# Load model
lnRR_model_pub_bias_year <- readRDS("RData/lnRR_model_pub_bias_year.rds")

# Display model output 
summary(lnRR_model_pub_bias_year)

# Cleaned model output
as.data.frame(fixef(lnRR_model_pub_bias_year, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from pub_year
    Parameter = gsub("scalepub_year", "pub_year", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

```{r, fig.width = 12, fig.height=10}

# Generate predictions
emmeans_pub_bias_year <- as.data.frame(emmeans(
  lnRR_model_pub_bias_year,
  specs = ~ pub_year | trait_type * warm_cold,
  at = list(pub_year = seq(min(data$pub_year), max(data$pub_year), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_pub_year = min(pub_year),
    max_pub_year = max(pub_year)
  )

emmeans_pub_bias_year$trait_type <- factor(emmeans_pub_bias_year$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_pub_bias_year$warm_cold <- factor(emmeans_pub_bias_year$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_pub_bias_year <- emmeans_pub_bias_year %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    pub_year >= min_pub_year,
    pub_year <= max_pub_year
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = pub_year, 
                      y = lnRR, 
                      size = 1/sqrt(pub_year), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_pub_bias_year, # Shaded area for credible intervals
                 aes(x = pub_year,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_pub_bias_year, # Predicted regression line
               aes(y = emmean,
                   x = pub_year,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.9, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Sampling variance of lnRR", y = "lnRR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none") + 
    coord_cartesian(ylim = c(-1.5, 1.5))

ggsave(file = "fig/lnRR_pub_bias_year.png", width = 12, height = 7, dpi = 500)
```

## **Changes in relative trait variance (lnCVR)** {.tabset .tabset_fade .tabset_pills}

### **Egger's regression** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnCVR ~ 0 + trait_type:warm_cold + 
                         trait_type:warm_cold:assay_temp_diff + 
                         trait_type:warm_cold:var_lnCVR + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnCVR_model_pub_bias_var <- brm(formula, 
                                            family = gaussian(),
                                            data = data, 
                                            data2 = list(phylo_matrix = phylo_matrix,
                                                         VCV_lnCVR = VCV_lnCVR),
                                            prior = prior,
                                            control = list(adapt_delta = 0.99, max_treedepth = 15),
                                            iter = 4000, 
                                            warmup = 2000,
                                            chains = 4, 
                                            cores = 4, 
                                            seed = 123) 
# Save model
saveRDS(lnCVR_model_pub_bias_var, file = "RData/lnCVR_model_pub_bias_var.rds")
```

#### *Model output*
```{r}
# Load model
lnCVR_model_pub_bias_var <- readRDS("RData/lnCVR_model_pub_bias_var.rds")

# Display model output 
summary(lnCVR_model_pub_bias_var)

# Cleaned model output
as.data.frame(fixef(lnCVR_model_pub_bias_var, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    Parameter = gsub("trait_type([a-z_]+)\\(warm\\):assay_temp_diff", "\\1(warm): assay_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_pub_bias_var <- as.data.frame(emmeans(
  lnCVR_model_pub_bias_var,
  specs = ~ var_lnCVR | trait_type * warm_cold,
  at = list(var_lnCVR = seq(0, max(data$var_lnCVR), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

emmeans_pub_bias_var$trait_type <- factor(emmeans_pub_bias_var$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_pub_bias_var$warm_cold <- factor(emmeans_pub_bias_var$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = var_lnCVR, 
                      y = lnCVR, 
                      size = 1/sqrt(var_lnCVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.1)) + 
     geom_ribbon(data = emmeans_pub_bias_var, # Shaded area for credible intervals
                 aes(x = var_lnCVR,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_pub_bias_var, # Predicted regression line
               aes(y = emmean,
                   x = var_lnCVR,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -1.9, -2.85),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Sampling variance of lnCVR", y = "lnCVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none") +
    coord_cartesian(ylim = c(-3.5, 3.5), xlim = c(0, 6))


ggsave(file = "fig/lnCVR_pub_bias_var.png", width = 12, height = 7, dpi = 500)
```

### **Publication year** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnCVR ~ 0 + trait_type:warm_cold + 
                         trait_type:warm_cold:assay_temp_diff + 
                         trait_type:warm_cold:scale(pub_year) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnCVR_model_pub_bias_year <- brm(formula, 
                                            family = gaussian(),
                                            data = data, 
                                            data2 = list(phylo_matrix = phylo_matrix,
                                                         VCV_lnCVR = VCV_lnCVR),
                                            prior = prior,
                                            control = list(adapt_delta = 0.99, max_treedepth = 15),
                                            iter = 4000, 
                                            warmup = 2000,
                                            chains = 4, 
                                            cores = 4, 
                                            seed = 123) 
# Save model
saveRDS(lnCVR_model_pub_bias_year, file = "RData/lnCVR_model_pub_bias_year.rds")
```

#### *Model output*
```{r}
# Load model
lnCVR_model_pub_bias_year <- readRDS("RData/lnCVR_model_pub_bias_year.rds")

# Display model output 
summary(lnCVR_model_pub_bias_year)

# Cleaned model output
as.data.frame(fixef(lnCVR_model_pub_bias_year, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from pub_year
    Parameter = gsub("scalepub_year", "pub_year", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

```{r, fig.width = 12, fig.height=10}

# Generate predictions
emmeans_pub_bias_year <- as.data.frame(emmeans(
  lnCVR_model_pub_bias_year,
  specs = ~ pub_year | trait_type * warm_cold,
  at = list(pub_year = seq(min(data$pub_year), max(data$pub_year), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_pub_year = min(pub_year),
    max_pub_year = max(pub_year)
  )

emmeans_pub_bias_year$trait_type <- factor(emmeans_pub_bias_year$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_pub_bias_year$warm_cold <- factor(emmeans_pub_bias_year$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_pub_bias_year <- emmeans_pub_bias_year %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    pub_year >= min_pub_year,
    pub_year <= max_pub_year
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = pub_year, 
                      y = lnCVR, 
                      size = 1/sqrt(pub_year), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_pub_bias_year, # Shaded area for credible intervals
                 aes(x = pub_year,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_pub_bias_year, # Predicted regression line
               aes(y = emmean,
                   x = pub_year,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -1.9, -2.85),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Publication year", y = "lnCVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none") + 
    coord_cartesian(ylim = c(-3, 3))

ggsave(file = "fig/lnCVR_pub_bias_year.png", width = 12, height = 7, dpi = 500)
```


## **Changes in trait variance (lnVR)** {.tabset .tabset_fade .tabset_pills}

### **Egger's regression** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnVR ~ 0 + trait_type:warm_cold + 
                         trait_type:warm_cold:assay_temp_diff + 
                         trait_type:warm_cold:var_lnVR + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnVR_model_pub_bias_var <- brm(formula, 
                                            family = gaussian(),
                                            data = data, 
                                            data2 = list(phylo_matrix = phylo_matrix,
                                                         VCV_lnVR = VCV_lnVR),
                                            prior = prior,
                                            control = list(adapt_delta = 0.99, max_treedepth = 15),
                                            iter = 4000, 
                                            warmup = 2000,
                                            chains = 4, 
                                            cores = 4, 
                                            seed = 123) 
# Save model
saveRDS(lnVR_model_pub_bias_var, file = "RData/lnVR_model_pub_bias_var.rds")
```

#### *Model output*
```{r}
# Load model
lnVR_model_pub_bias_var <- readRDS("RData/lnVR_model_pub_bias_var.rds")

# Display model output 
summary(lnVR_model_pub_bias_var)

# Cleaned model output
as.data.frame(fixef(lnVR_model_pub_bias_var, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    Parameter = gsub("trait_type([a-z_]+)\\(warm\\):assay_temp_diff", "\\1(warm): assay_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_pub_bias_var <- as.data.frame(emmeans(
  lnVR_model_pub_bias_var,
  specs = ~ var_lnVR | trait_type * warm_cold,
  at = list(var_lnVR = seq(0, max(data$var_lnVR), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

emmeans_pub_bias_var$trait_type <- factor(emmeans_pub_bias_var$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_pub_bias_var$warm_cold <- factor(emmeans_pub_bias_var$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = var_lnVR, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_pub_bias_var, # Shaded area for credible intervals
                 aes(x = var_lnVR,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_pub_bias_var, # Predicted regression line
               aes(y = emmean,
                   x = var_lnVR,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2.3, -3.25),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Sampling variance of lnVR", y = "lnVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5), xlim = c(0, 6))


ggsave(file = "fig/lnVR_pub_bias_var.png", width = 12, height = 7, dpi = 500)
```

### **Publication year** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnVR ~ 0 + trait_type:warm_cold + 
                         trait_type:warm_cold:assay_temp_diff + 
                         trait_type:warm_cold:scale(pub_year) + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnVR_model_pub_bias_year <- brm(formula, 
                                            family = gaussian(),
                                            data = data, 
                                            data2 = list(phylo_matrix = phylo_matrix,
                                                         VCV_lnVR = VCV_lnVR),
                                            prior = prior,
                                            control = list(adapt_delta = 0.99, max_treedepth = 15),
                                            iter = 4000, 
                                            warmup = 2000,
                                            chains = 4, 
                                            cores = 4, 
                                            seed = 123) 
# Save model
saveRDS(lnVR_model_pub_bias_year, file = "RData/lnVR_model_pub_bias_year.rds")
```

#### *Model output*
```{r}
# Load model
lnVR_model_pub_bias_year <- readRDS("RData/lnVR_model_pub_bias_year.rds")

# Display model output 
summary(lnVR_model_pub_bias_year)

# Cleaned model output
as.data.frame(fixef(lnVR_model_pub_bias_year, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `warm_cold` interactions
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((cold|warm)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter),
    # Remove "scale" from pub_year
    Parameter = gsub("scalepub_year", "pub_year", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation*

```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_pub_bias_year <- as.data.frame(emmeans(
  lnVR_model_pub_bias_year,
  specs = ~ pub_year | trait_type * warm_cold,
  at = list(pub_year = seq(min(data$pub_year), max(data$pub_year), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0


# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_pub_year = min(pub_year),
    max_pub_year = max(pub_year)
  )

emmeans_pub_bias_year$trait_type <- factor(emmeans_pub_bias_year$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_pub_bias_year$warm_cold <- factor(emmeans_pub_bias_year$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_pub_bias_year <- emmeans_pub_bias_year %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    pub_year >= min_pub_year,
    pub_year <= max_pub_year
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = pub_year, 
                      y = lnVR, 
                      size = 1/sqrt(pub_year), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_pub_bias_year, # Shaded area for credible intervals
                 aes(x = pub_year,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_pub_bias_year, # Predicted regression line
               aes(y = emmean,
                   x = pub_year,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2.3, -3.25),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Sampling variance of lnVR", y = "lnVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none") + 
    coord_cartesian(ylim = c(-3.5, 3.5))


ggsave(file = "fig/lnVR_pub_bias_year.png", width = 12, height = 7, dpi = 500)
```


# **Sensitivity analyses** 

Note that, although mentioned in our pre-registration, we did not compare estimates from peer-reviewed publications and academic theses. This is because only a single included study was a thesis. 

Prepare dataset for subset analyses
```{r}
# Filter to only warm temperatures
data_warm <- filter(data, warm_cold == "Warm")

# Drop tips that are not in the warm dataset
tips_to_drop <- setdiff(phylo_tree$tip.label, data_warm$phylogeny)
phylo_tree_warm <- drop.tip(phylo_tree, tips_to_drop)

# Compute phylogenetic correlation matrix
phylo_matrix_warm <- vcv(phylo_tree_warm, cor = T)  # The vcv function returns a variance-covariance matrix

# Convert tibble to data frame
data_warm <- as.data.frame(data_warm)

# Calculate VCV matrix for all three responses
VCV_lnRR_warm <- vcalc(vi = var_lnRR,
                        cluster = shared_control_ID, 
                        rho = 0.5,
                        obs = obs,
                        data = data_warm) 

VCV_lnCVR_warm <- vcalc(vi = var_lnCVR,
                        cluster = shared_control_ID, 
                        rho = 0.5,
                        obs = obs,
                        data = data_warm) 

VCV_lnVR_warm <- vcalc(vi = var_lnVR,
                        cluster = shared_control_ID, 
                        rho = 0.5,
                        obs = obs,
                        data = data_warm) 
```

## **Changes in mean responses (lnRR)** {.tabset .tabset_fade .tabset_pills}

### **Constant vs. increasing temperatures** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnRR ~ 0 + trait_type:constant_increasing + trait_type:constant_increasing:assay_temp_diff + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix_warm)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR_warm)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnRR_model_constant_increasing <- brm(formula, 
                                       family = gaussian(),
                                       data = data_warm, 
                                       data2 = list(phylo_matrix_warm = phylo_matrix_warm,
                                                    VCV_lnRR_warm = VCV_lnRR_warm),
                                       prior = prior,
                                       control = list(adapt_delta = 0.99, max_treedepth = 15),
                                       iter = 4000, 
                                       warmup = 2000,
                                       chains = 4, 
                                       cores = 4, 
                                       seed = 123) 

# Save model
saveRDS(lnRR_model_constant_increasing, file = "RData/lnRR_model_constant_increasing.rds")
```

#### *Model output*
```{r}
# Load model
lnRR_model_constant_increasing <- readRDS("RData/lnRR_model_constant_increasing.rds")

# Display model output 
summary(lnRR_model_constant_increasing)

# Cleaned model output
as.data.frame(fixef(lnRR_model_constant_increasing, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `constant_increasing` interactions
    Parameter = gsub("trait_type([a-z_]+):constant_increasing(constant|increasing)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((constant|increasing)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Contrasts* 
```{r}
# Generate predictions
emms <- emmeans(lnRR_model_constant_increasing, 
                specs = ~ constant_increasing | trait_type,
                at = list(assay_temp_diff = 0))

# Generate contrasts
contrast(emms, method = "pairwise")
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_constant_increasing <- as.data.frame(emmeans(lnRR_model_constant_increasing, 
                                                     specs = ~ constant_increasing | trait_type,
                                                     at = list(assay_temp_diff = 0)))

emmeans_constant_increasing$trait_type <- factor(emmeans_constant_increasing$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_constant_increasing$constant_increasing <- factor(emmeans_constant_increasing$constant_increasing, 
                          levels = c("constant", "increasing"), 
                          labels = c("Constant", "Increasing"))

data_warm$constant_increasing <- factor(data_warm$constant_increasing, 
                          levels = c("constant", "increasing"), 
                          labels = c("Constant", "Increasing"))


# Calculate sample sizes and study counts
sample_sizes_warm <- data_warm %>%
  group_by(trait_type, constant_increasing) %>%
  summarise(
    estimates = n(),
    studies = n_distinct(ref)
  )

# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_quasirandom(data = data_warm,     # Plot effect sizes, scaled by precision
                     aes(x = trait_type:constant_increasing, 
                         y = lnRR, 
                         fill = trait_type:constant_increasing, 
                         size = 1/sqrt(var_lnRR)), 
                     color = "black",
                     shape = 21,
                     width = 0.25, 
                     alpha = 0.45) +
    geom_errorbar(data = emmeans_constant_increasing,  # Plot the point estimates in white for background
                  aes(x = trait_type:constant_increasing, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.5,
                  width = 0.17) +
    geom_point(data = emmeans_constant_increasing,  # Plot the credible intervals in white for background
               aes(x = trait_type:constant_increasing, 
                   y = emmean),
               shape = 21,
               size = 4, 
               stroke = 2,
               color="white",
               fill = "white") +
    geom_errorbar(data = emmeans_constant_increasing, # Plot the point estimates 
                  aes(x = trait_type:constant_increasing, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="black",
                  size = 2,
                  width = 0.15) +
    geom_point(data = emmeans_constant_increasing, # Plot the credible intervals
               aes(x = trait_type:constant_increasing, 
                   y = emmean),
               shape = 21,
               size = 3.5, 
               stroke = 2,
               color="black",
               fill = "white") +
    geom_text(data = sample_sizes_warm,  # Sample size annotations 
              aes(x = trait_type:constant_increasing, 
                  y = 1.5,
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = constant_increasing), 
              hjust = 1, size = 5, show.legend = FALSE) +
    theme_bw() +     # Customize the plot
    labs(y = "lnRR", x = "") +
    scale_size_continuous(range = c(2, 8))+ 
    scale_fill_manual(values = c("#8E77FF", "#FF6040", "#8E77FF", "#FF6040", "#8E77FF", "#FF6040"))+
    scale_color_manual(values = c("Constant" = "#8E77FF", "Increasing" = "#FF6040")) +  # Text colour
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5)) +
    guides(fill = "none", size = "none")+
    coord_flip() + 
    ylim(-1.5, 1.5)

ggsave(file = "fig/lnRR_constant_increasing.png", width = 12, height = 7, dpi = 500)
```

### **Leave-one-out analysis** 

#### *Model specification*
```{r, eval = F}
# Get a list of study IDs for the LOO
study_ids <- unique(data$ref)
num_studies <- length(study_ids)

# Initialize a list to store the results
loo_results <- vector("list", num_studies)
names(loo_results) <- study_ids

# Set up parallel processing (16 models at a time)
plan(multisession, workers = 16)  

# Model specification
formula <- bf(lnRR ~ trait_type -1 + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant


# Function to fit the model after iteratively removing one study
leave_one_out <- function(study_id) {
  # Subset the data
  data_subset <- subset(data, ref != study_id)
  
  # Recalculate VCV matrix
  VCV_lnRR_subset <- vcalc(
    vi = var_lnRR,
    cluster = shared_control_ID, 
    rho = 0.5,
    obs = obs,
    data = data_subset
  )
  
  # Fit the model
  model_subset <- brm(
    formula, 
    family = gaussian(),
    data = data_subset, 
    data2 = list(
      phylo_matrix = phylo_matrix,
      VCV_lnRR = VCV_lnRR_subset
    ),
    prior = prior,
    control = list(adapt_delta = 0.99, max_treedepth = 15),
    iter = 2000, # Reduce to 2000 iterations to reduce computational demands
    warmup = 1000, 
    chains = 2, # Only two chains to reduce computational demands
    cores = 1,   # Set cores to 1 inside the function
    seed = 123
  )

  # Extract the fixed effects
  fixed_effects <- fixef(model_subset)
  
  # Return the fixed effects
  return(list(study_id = study_id, fixed_effects = fixed_effects))
}

# Run the function in parallel over the studies
loo_results <- future_lapply(study_ids, leave_one_out)

# Save results
saveRDS(loo_results, file = "RData/lnRR_LOO_results.rds")
```

#### *Model summary*
```{r}
# Load the list of all model outputs
loo_lnRR <- readRDS(file = "RData/lnRR_LOO_results.rds") 

# Extract data on fixed effects from each model

loo_results_lnRR <- do.call(rbind, lapply(loo_lnRR, function(x) {
  # Extract study_id and fixed_effects data
  study_id <- x$study_id
  fixed_effects <- x$fixed_effects
  
  # Convert row names (trait_type) to a column, remove prefix, and add study_id
  fixed_effects <- data.frame(trait_type = sub("trait_type", "", rownames(fixed_effects)), fixed_effects)
  fixed_effects$study_id <- study_id
  
  # Remove row names
  rownames(fixed_effects) <- NULL
  
  return(fixed_effects)
}))

loo_results_lnRR$trait_type <- factor(loo_results_lnRR$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

# Summarise the data
loo_results_lnRR %>% 
  group_by(trait_type) %>% 
  summarise(Estimate = mean(Estimate),
            SE = mean(Est.Error), 
            lower_CI = mean(Q2.5),
            upper_CI = mean(Q97.5)) # Mean across all models
```

#### *Data visualisation* 
```{r, fig.width = 12, fig.height=15}
# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_errorbar(data = loo_results_lnRR,  # Plot the credible intervals in white for background
               aes(x = study_id, 
                   y = Estimate,
                   ymin = Q2.5, 
                   ymax = Q97.5,
                   color = trait_type),
               shape = 21,
               size = 1,
               width = 0.3) +
    geom_point(data = loo_results_lnRR,
               aes(x = study_id, 
                   y = Estimate,
                   fill = trait_type),
               shape = 21,
               size = 4, 
               stroke = 1,
               color="black") +
    theme_bw() +     # Customize the plot
    labs(y = "lnRR", x = "") +
    scale_fill_manual(values = c("#73B706", "#06A2BA", "#B90674"))+
    scale_color_manual(values = c("#73B706", "#06A2BA", "#B90674")) +  
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 10, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5),
          strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 20)) +
    guides(fill = "none", color = "none")+
    coord_flip()+
    xlim(-0.15, 0.15) +
    facet_wrap(~trait_type, ncol = 3)+
    scale_x_discrete(limits = rev(levels(as.factor(loo_results_lnRR$study_id)))) # Alphabetical order

ggsave(file = "fig/lnRR_LOO.png", width = 12, height = 12, dpi = 500)
```


### **Unusual study designs** 

#### *Model specification*
```{r, eval = F}
# Discard observations flagged because the number of generations of selection was unclear, as this would only affect the results of meta-regressions
data <- mutate(data, minor_concerns2 = ifelse(minor_concerns == "gen_selection approximate" | 
                                               minor_concerns == "gen_selection underestimated",
                     NA, minor_concerns)) 

# Filter to data without sources of procedural  concerns.
data_concerns <- filter(data, is.na(major_concerns)==T & is.na(minor_concerns2)==T)

# Drop tips that are not in the warm dataset
tips_to_drop <- setdiff(phylo_tree$tip.label, data_concerns$phylogeny)
phylo_tree_concerns <- drop.tip(phylo_tree, tips_to_drop)

# Compute phylogenetic correlation matrix
phylo_matrix_concerns <- vcv(phylo_tree_concerns, cor = T)  # The vcv function returns a variance-covariance matrix

# Convert tibble to data frame
data_concerns <- as.data.frame(data_concerns)

# Calculate VCV matrix
VCV_lnRR_concerns <- vcalc(vi = var_lnRR,
                       cluster = shared_control_ID, 
                       rho = 0.5,
                       obs = obs,
                       data = data_concerns) 

# Model specification
formula <- bf(lnRR ~ 0 + trait_type:warm_cold + trait_type:warm_cold:assay_temp_diff + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix_concerns)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnRR_concerns)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnRR_model_concerns <- brm(formula, 
                                      family = gaussian(),
                                      data = data_concerns, 
                                      data2 = list(phylo_matrix_concerns = phylo_matrix_concerns,
                                                   VCV_lnRR_concerns = VCV_lnRR_concerns),
                                      prior = prior,
                                      control = list(adapt_delta = 0.99, max_treedepth = 15),
                                      iter = 4000, 
                                      warmup = 2000,
                                      chains = 4, 
                                      cores = 4, 
                                      seed = 123) 
# Save model
saveRDS(lnRR_model_concerns, file = "RData/lnRR_model_concerns.rds")
```

#### *Model summary*
```{r}
# Load model
lnRR_model_concerns <- readRDS("RData/lnRR_model_concerns.rds")

# Display model output 
summary(lnRR_model_concerns)

# Cleaned model output
as.data.frame(fixef(lnRR_model_concerns, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    Parameter = gsub("trait_type([a-z_]+)\\(warm\\):assay_temp_diff", "\\1(warm): assay_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation* 
```{r, fig.width = 12, fig.height=10}
# Discard observations flagged because the number of generations of selection was unclear, as this would only affect the results of meta-regressions
data <- mutate(data, minor_concerns2 = ifelse(minor_concerns == "gen_selection approximate" | 
                                               minor_concerns == "gen_selection underestimated",
                     NA, minor_concerns)) 

# Filter to data without sources of procedural  concerns.
data_concerns <- filter(data, is.na(major_concerns)==T & is.na(minor_concerns2)==T)

# Calculate sample sizes and study counts
sample_sizes_concerns <- data_concerns %>%
  group_by(trait_type, warm_cold) %>%
  summarise(
    estimates = n(),
    studies = n_distinct(ref)
  )

# Generate predictions
emmeans_concerns <- as.data.frame(emmeans(
  lnRR_model_concerns,
  specs = ~ assay_temp_diff | trait_type * warm_cold,
  at = list(assay_temp_diff = seq(min(data_concerns$assay_temp_diff), max(data_concerns$assay_temp_diff), by = 0.5)))
  )

# Calculate range of values for each category
range_df_concerns <- data_concerns %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

emmeans_concerns$trait_type <- factor(emmeans_concerns$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_concerns$warm_cold <- factor(emmeans_concerns$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_concerns <- emmeans_concerns %>%
  left_join(range_df_concerns, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data_concerns, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_concerns, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_concerns,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
    geom_text(data = sample_sizes_concerns, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.9, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnRR",
       col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-1.5, 1.5))

ggsave(file = "fig/lnRR_concerns.png", width = 12, height = 7, dpi = 500)
```


## **Changes in relative trait variance (lnCVR)** {.tabset .tabset_fade .tabset_pills}

### **Constant vs. increasing temperatures** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnCVR ~ 0 + trait_type:constant_increasing + trait_type:constant_increasing:assay_temp_diff + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix_warm)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR_warm)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnCVR_model_constant_increasing <- brm(formula, 
                                       family = gaussian(),
                                       data = data_warm, 
                                       data2 = list(phylo_matrix_warm = phylo_matrix_warm,
                                                    VCV_lnCVR_warm = VCV_lnCVR_warm),
                                       prior = prior,
                                       control = list(adapt_delta = 0.99, max_treedepth = 15),
                                       iter = 4000, 
                                       warmup = 2000,
                                       chains = 4, 
                                       cores = 4, 
                                       seed = 123) 

# Save model
saveRDS(lnCVR_model_constant_increasing, file = "RData/lnCVR_model_constant_increasing.rds")
```

#### *Model output*
```{r}
# Load model
lnCVR_model_constant_increasing <- readRDS("RData/lnCVR_model_constant_increasing.rds")

# Display model output 
summary(lnCVR_model_constant_increasing)

# Cleaned model output
as.data.frame(fixef(lnCVR_model_constant_increasing, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `constant_increasing` interactions
    Parameter = gsub("trait_type([a-z_]+):constant_increasing(constant|increasing)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((constant|increasing)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Contrasts* 
```{r}
# Generate predictions
emms <- emmeans(lnCVR_model_constant_increasing, 
                specs = ~ constant_increasing | trait_type,
                at = list(assay_temp_diff = 0))

# Generate contrasts
contrast(emms, method = "pairwise")
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_constant_increasing <- as.data.frame(emmeans(lnCVR_model_constant_increasing, 
                                                     specs = ~ constant_increasing | trait_type,
                                                     at = list(assay_temp_diff = 0)))

emmeans_constant_increasing$trait_type <- factor(emmeans_constant_increasing$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_constant_increasing$constant_increasing <- factor(emmeans_constant_increasing$constant_increasing, 
                          levels = c("constant", "increasing"), 
                          labels = c("Constant", "Increasing"))

# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_quasirandom(data = data_warm,     # Plot effect sizes, scaled by precision
                     aes(x = trait_type:constant_increasing, 
                         y = lnCVR, 
                         fill = trait_type:constant_increasing, 
                         size = 1/sqrt(var_lnCVR)), 
                     color = "black",
                     shape = 21,
                     width = 0.25, 
                     alpha = 0.45) +
    geom_errorbar(data = emmeans_constant_increasing,  # Plot the point estimates in white for background
                  aes(x = trait_type:constant_increasing, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.5,
                  width = 0.17) +
    geom_point(data = emmeans_constant_increasing,  # Plot the credible intervals in white for background
               aes(x = trait_type:constant_increasing, 
                   y = emmean),
               shape = 21,
               size = 4, 
               stroke = 2,
               color="white",
               fill = "white") +
    geom_errorbar(data = emmeans_constant_increasing, # Plot the point estimates 
                  aes(x = trait_type:constant_increasing, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="black",
                  size = 2,
                  width = 0.15) +
    geom_point(data = emmeans_constant_increasing, # Plot the credible intervals
               aes(x = trait_type:constant_increasing, 
                   y = emmean),
               shape = 21,
               size = 3.5, 
               stroke = 2,
               color="black",
               fill = "white") +
    geom_text(data = sample_sizes_warm,  # Sample size annotations 
              aes(x = trait_type:constant_increasing, 
                  y = 3,
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = constant_increasing), 
              hjust = 1, size = 5, show.legend = FALSE) +
    theme_bw() +     # Customize the plot
    labs(y = "lnCVR", x = "") +
    scale_size_continuous(range = c(2, 8))+ 
    scale_fill_manual(values = c("#8E77FF", "#FF6040", "#8E77FF", "#FF6040", "#8E77FF", "#FF6040"))+
    scale_color_manual(values = c("Constant" = "#8E77FF", "Increasing" = "#FF6040")) +  # Text colour
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5)) +
    guides(fill = "none", size = "none")+
    coord_flip() + 
    ylim(-3, 3)

ggsave(file = "fig/lnCVR_constant_increasing.png", width = 12, height = 7, dpi = 500)
```

### **Leave-one-out analysis** 

#### *Model specification*
```{r, eval = F}
# Get a list of study IDs for the LOO
study_ids <- unique(data$ref)
num_studies <- length(study_ids)

# Initialize a list to store the results
loo_results <- vector("list", num_studies)
names(loo_results) <- study_ids

# Set up parallel processing (16 models at a time)
plan(multisession, workers = 16)  

# Model specification
formula <- bf(lnCVR ~ trait_type -1 + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant


# Function to fit the model after iteratively removing one study
leave_one_out <- function(study_id) {
  # Subset the data
  data_subset <- subset(data, ref != study_id)
  
  # Recalculate VCV matrix
  VCV_lnCVR_subset <- vcalc(
    vi = var_lnCVR,
    cluster = shared_control_ID, 
    rho = 0.5,
    obs = obs,
    data = data_subset
  )
  
  # Fit the model
  model_subset <- brm(
    formula, 
    family = gaussian(),
    data = data_subset, 
    data2 = list(
      phylo_matrix = phylo_matrix,
      VCV_lnCVR = VCV_lnCVR_subset
    ),
    prior = prior,
    control = list(adapt_delta = 0.99, max_treedepth = 15),
    iter = 2000, # Reduce to 2000 iterations to reduce computational demands
    warmup = 1000, 
    chains = 2, # Only two chains to reduce computational demands
    cores = 1,   # Set cores to 1 inside the function
    seed = 123
  )

  # Extract the fixed effects
  fixed_effects <- fixef(model_subset)
  
  # Return the fixed effects
  return(list(study_id = study_id, fixed_effects = fixed_effects))
}

# Run the function in parallel over the studies
loo_results <- future_lapply(study_ids, leave_one_out)

# Save results
saveRDS(loo_results, file = "RData/lnCVR_LOO_results.rds")
```

#### *Model summary*
```{r}
# Load the list of all model outputs
loo_lnCVR <- readRDS(file = "RData/lnCVR_LOO_results.rds") 

# Extract data on fixed effects from each model

loo_results_lnCVR <- do.call(rbind, lapply(loo_lnCVR, function(x) {
  # Extract study_id and fixed_effects data
  study_id <- x$study_id
  fixed_effects <- x$fixed_effects
  
  # Convert row names (trait_type) to a column, remove prefix, and add study_id
  fixed_effects <- data.frame(trait_type = sub("trait_type", "", rownames(fixed_effects)), fixed_effects)
  fixed_effects$study_id <- study_id
  
  # Remove row names
  rownames(fixed_effects) <- NULL
  
  return(fixed_effects)
}))

loo_results_lnCVR$trait_type <- factor(loo_results_lnCVR$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

# Summarise the data
loo_results_lnCVR %>% 
  group_by(trait_type) %>% 
  summarise(Estimate = mean(Estimate),
            SE = mean(Est.Error), 
            lower_CI = mean(Q2.5),
            upper_CI = mean(Q97.5)) # Mean across all models
```

#### *Data visualisation* 
```{r, fig.width = 12, fig.height=15}
# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_errorbar(data = loo_results_lnCVR,  # Plot the credible intervals in white for background
               aes(x = study_id, 
                   y = Estimate,
                   ymin = Q2.5, 
                   ymax = Q97.5,
                   color = trait_type),
               shape = 21,
               size = 1,
               width = 0.3) +
    geom_point(data = loo_results_lnCVR,
               aes(x = study_id, 
                   y = Estimate,
                   fill = trait_type),
               shape = 21,
               size = 4, 
               stroke = 1,
               color="black") +
    theme_bw() +     # Customize the plot
    labs(y = "lnCVR", x = "") +
    scale_fill_manual(values = c("#73B706", "#06A2BA", "#B90674"))+
    scale_color_manual(values = c("#73B706", "#06A2BA", "#B90674")) +  
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 10, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5),
          strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 20)) +
    guides(fill = "none", color = "none")+
    coord_flip()+
    xlim(-0.4, 0.4)+
    facet_wrap(~trait_type, ncol = 3)+
   scale_x_discrete(limits = rev(levels(as.factor(loo_results_lnCVR$study_id)))) # Alphabetical order

ggsave(file = "fig/lnCVR_LOO.png", width = 12, height = 12, dpi = 500)
```


### **Unusual study designs** 

#### *Model specification*
```{r, eval = F}
# Discard observations flagged because the number of generations of selection was unclear, as this would only affect the results of meta-regressions
data <- mutate(data, minor_concerns2 = ifelse(minor_concerns == "gen_selection approximate" | 
                                               minor_concerns == "gen_selection underestimated",
                     NA, minor_concerns)) 

# Filter to data without sources of procedural  concerns.
data_concerns <- filter(data, is.na(major_concerns)==T & is.na(minor_concerns2)==T)

# Drop tips that are not in the warm dataset
tips_to_drop <- setdiff(phylo_tree$tip.label, data_concerns$phylogeny)
phylo_tree_concerns <- drop.tip(phylo_tree, tips_to_drop)

# Compute phylogenetic correlation matrix
phylo_matrix_concerns <- vcv(phylo_tree_concerns, cor = T)  # The vcv function returns a variance-covariance matrix

# Convert tibble to data frame
data_concerns <- as.data.frame(data_concerns)

# Calculate VCV matrix
VCV_lnCVR_concerns <- vcalc(vi = var_lnCVR,
                       cluster = shared_control_ID, 
                       rho = 0.5,
                       obs = obs,
                       data = data_concerns) 

# Model specification
formula <- bf(lnCVR ~ 0 + trait_type:warm_cold + trait_type:warm_cold:assay_temp_diff + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix_concerns)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnCVR_concerns)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnCVR_model_concerns <- brm(formula, 
                                      family = gaussian(),
                                      data = data_concerns, 
                                      data2 = list(phylo_matrix_concerns = phylo_matrix_concerns,
                                                   VCV_lnCVR_concerns = VCV_lnCVR_concerns),
                                      prior = prior,
                                      control = list(adapt_delta = 0.99, max_treedepth = 15),
                                      iter = 4000, 
                                      warmup = 2000,
                                      chains = 4, 
                                      cores = 4, 
                                      seed = 123) 
# Save model
saveRDS(lnCVR_model_concerns, file = "RData/lnCVR_model_concerns.rds")
```

#### *Model summary*
```{r}
# Load model
lnCVR_model_concerns <- readRDS("RData/lnCVR_model_concerns.rds")

# Display model output 
summary(lnCVR_model_concerns)

# Cleaned model output
as.data.frame(fixef(lnCVR_model_concerns, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    Parameter = gsub("trait_type([a-z_]+)\\(warm\\):assay_temp_diff", "\\1(warm): assay_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation* 
```{r, fig.width = 12, fig.height=10}
# Discard observations flagged because the number of generations of selection was unclear, as this would only affect the results of meta-regressions
data <- mutate(data, minor_concerns2 = ifelse(minor_concerns == "gen_selection approximate" | 
                                               minor_concerns == "gen_selection underestimated",
                     NA, minor_concerns)) 

# Filter to data without sources of procedural  concerns.
data_concerns <- filter(data, is.na(major_concerns)==T & is.na(minor_concerns2)==T)

# Calculate sample sizes and study counts
sample_sizes_concerns <- data_concerns %>%
  group_by(trait_type, warm_cold) %>%
  summarise(
    estimates = n(),
    studies = n_distinct(ref)
  )

# Generate predictions
emmeans_concerns <- as.data.frame(emmeans(
  lnCVR_model_concerns,
  specs = ~ assay_temp_diff | trait_type * warm_cold,
  at = list(assay_temp_diff = seq(min(data_concerns$assay_temp_diff), max(data_concerns$assay_temp_diff), by = 0.5))))

# Calculate range of values for each category
range_df_concerns <- data_concerns %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

emmeans_concerns$trait_type <- factor(emmeans_concerns$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_concerns$warm_cold <- factor(emmeans_concerns$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_concerns <- emmeans_concerns %>%
  left_join(range_df_concerns, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data_concerns, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnCVR, 
                      size = 1/sqrt(var_lnCVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_concerns, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_concerns,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
    geom_text(data = sample_sizes_concerns, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnCVR",
       col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3, 3))

ggsave(file = "fig/lnCVR_concerns.png", width = 12, height = 7, dpi = 500)
```

## **Changes in trait variance (lnVR)** {.tabset .tabset_fade .tabset_pills}

### **Constant vs. increasing temperatures** 

#### *Model specification*
```{r, eval = F}
# Model specification
formula <- bf(lnVR ~ 0 + trait_type:constant_increasing + trait_type:constant_increasing:assay_temp_diff + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix_warm)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR_warm)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnVR_model_constant_increasing <- brm(formula, 
                                       family = gaussian(),
                                       data = data_warm, 
                                       data2 = list(phylo_matrix_warm = phylo_matrix_warm,
                                                    VCV_lnVR_warm = VCV_lnVR_warm),
                                       prior = prior,
                                       control = list(adapt_delta = 0.99, max_treedepth = 15),
                                       iter = 4000, 
                                       warmup = 2000,
                                       chains = 4, 
                                       cores = 4, 
                                       seed = 123) 

# Save model
saveRDS(lnVR_model_constant_increasing, file = "RData/lnVR_model_constant_increasing.rds")
```

#### *Model output*
```{r}
# Load model
lnVR_model_constant_increasing <- readRDS("RData/lnVR_model_constant_increasing.rds")

# Display model output 
summary(lnVR_model_constant_increasing)

# Cleaned model output
as.data.frame(fixef(lnVR_model_constant_increasing, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>%
  mutate(
    # Simplify `trait_type` and `constant_increasing` interactions
    Parameter = gsub("trait_type([a-z_]+):constant_increasing(constant|increasing)", "\\1(\\2)", Parameter),
    # Adjust for assay_temp_diff
    Parameter = gsub("trait_type([a-z_]+)\\((constant|increasing)\\):assay_temp_diff", "\\1(\\2): assay_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Contrasts* 
```{r}
# Generate predictions
emms <- emmeans(lnVR_model_constant_increasing, 
                specs = ~ constant_increasing | trait_type,
                at = list(assay_temp_diff = 0))

# Generate contrasts
contrast(emms, method = "pairwise")
```

#### *Data visualisation*
```{r, fig.width = 12, fig.height=10}
# Generate predictions
emmeans_constant_increasing <- as.data.frame(emmeans(lnVR_model_constant_increasing, 
                                                     specs = ~ constant_increasing | trait_type,
                                                     at = list(assay_temp_diff = 0)))

emmeans_constant_increasing$trait_type <- factor(emmeans_constant_increasing$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_constant_increasing$constant_increasing <- factor(emmeans_constant_increasing$constant_increasing, 
                          levels = c("constant", "increasing"), 
                          labels = c("Constant", "Increasing"))

# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_quasirandom(data = data_warm,     # Plot effect sizes, scaled by precision
                     aes(x = trait_type:constant_increasing, 
                         y = lnVR, 
                         fill = trait_type:constant_increasing, 
                         size = 1/sqrt(var_lnVR)), 
                     color = "black",
                     shape = 21,
                     width = 0.25, 
                     alpha = 0.45) +
    geom_errorbar(data = emmeans_constant_increasing,  # Plot the point estimates in white for background
                  aes(x = trait_type:constant_increasing, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="white",
                  size = 2.5,
                  width = 0.17) +
    geom_point(data = emmeans_constant_increasing,  # Plot the credible intervals in white for background
               aes(x = trait_type:constant_increasing, 
                   y = emmean),
               shape = 21,
               size = 4, 
               stroke = 2,
               color="white",
               fill = "white") +
    geom_errorbar(data = emmeans_constant_increasing, # Plot the point estimates 
                  aes(x = trait_type:constant_increasing, 
                      ymin = lower.HPD, 
                      ymax = upper.HPD), 
                  color="black",
                  size = 2,
                  width = 0.15) +
    geom_point(data = emmeans_constant_increasing, # Plot the credible intervals
               aes(x = trait_type:constant_increasing, 
                   y = emmean),
               shape = 21,
               size = 3.5, 
               stroke = 2,
               color="black",
               fill = "white") +
    geom_text(data = sample_sizes_warm,  # Sample size annotations 
              aes(x = trait_type:constant_increasing, 
                  y = 3.5,
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = constant_increasing), 
              hjust = 1, size = 5, show.legend = FALSE) +
    theme_bw() +     # Customize the plot
    labs(y = "lnVR", x = "") +
    scale_size_continuous(range = c(2, 8))+ 
    scale_fill_manual(values = c("#8E77FF", "#FF6040", "#8E77FF", "#FF6040", "#8E77FF", "#FF6040"))+
    scale_color_manual(values = c("Constant" = "#8E77FF", "Increasing" = "#FF6040")) +  # Text colour
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5)) +
    guides(fill = "none", size = "none")+
    coord_flip() + 
    ylim(-3.5, 3.5)

ggsave(file = "fig/lnVR_constant_increasing.png", width = 12, height = 7, dpi = 500)
```

### **Leave-one-out analysis** 

#### *Model specification*
```{r, eval = F}
# Get a list of study IDs for the LOO
study_ids <- unique(data$ref)
num_studies <- length(study_ids)

# Initialize a list to store the results
loo_results <- vector("list", num_studies)
names(loo_results) <- study_ids

# Set up parallel processing (16 models at a time)
plan(multisession, workers = 16)  

# Model specification
formula <- bf(lnVR ~ trait_type -1 + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant


# Function to fit the model after iteratively removing one study
leave_one_out <- function(study_id) {
  # Subset the data
  data_subset <- subset(data, ref != study_id)
  
  # Recalculate VCV matrix
  VCV_lnVR_subset <- vcalc(
    vi = var_lnVR,
    cluster = shared_control_ID, 
    rho = 0.5,
    obs = obs,
    data = data_subset
  )
  
  # Fit the model
  model_subset <- brm(
    formula, 
    family = gaussian(),
    data = data_subset, 
    data2 = list(
      phylo_matrix = phylo_matrix,
      VCV_lnVR = VCV_lnVR_subset
    ),
    prior = prior,
    control = list(adapt_delta = 0.99, max_treedepth = 15),
    iter = 2000, # Reduce to 2000 iterations to reduce computational demands
    warmup = 1000, 
    chains = 2, # Only two chains to reduce computational demands
    cores = 1,   # Set cores to 1 inside the function
    seed = 123
  )

  # Extract the fixed effects
  fixed_effects <- fixef(model_subset)
  
  # Return the fixed effects
  return(list(study_id = study_id, fixed_effects = fixed_effects))
}

# Run the function in parallel over the studies
loo_results <- future_lapply(study_ids, leave_one_out)

# Save results
saveRDS(loo_results, file = "RData/lnVR_LOO_results.rds")
```

#### *Model summary*
```{r}
# Load the list of all model outputs
loo_lnVR <- readRDS(file = "RData/lnVR_LOO_results.rds") 

# Extract data on fixed effects from each model

loo_results_lnVR <- do.call(rbind, lapply(loo_lnVR, function(x) {
  # Extract study_id and fixed_effects data
  study_id <- x$study_id
  fixed_effects <- x$fixed_effects
  
  # Convert row names (trait_type) to a column, remove prefix, and add study_id
  fixed_effects <- data.frame(trait_type = sub("trait_type", "", rownames(fixed_effects)), fixed_effects)
  fixed_effects$study_id <- study_id
  
  # Remove row names
  rownames(fixed_effects) <- NULL
  
  return(fixed_effects)
}))

loo_results_lnVR$trait_type <- factor(loo_results_lnVR$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

# Summarise the data
loo_results_lnVR %>% 
  group_by(trait_type) %>% 
  summarise(Estimate = mean(Estimate),
            SE = mean(Est.Error), 
            lower_CI = mean(Q2.5),
            upper_CI = mean(Q97.5)) # Mean across all models
```

#### *Data visualisation* 
```{r, fig.width = 12, fig.height=15}
# Plot
ggplot() +
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75, 
               lwd=1) +
    geom_errorbar(data = loo_results_lnVR,  # Plot the credible intervals in white for background
               aes(x = study_id, 
                   y = Estimate,
                   ymin = Q2.5, 
                   ymax = Q97.5,
                   color = trait_type),
               shape = 21,
               size = 1,
               width = 0.3) +
    geom_point(data = loo_results_lnVR,
               aes(x = study_id, 
                   y = Estimate,
                   fill = trait_type),
               shape = 21,
               size = 4, 
               stroke = 1,
               color="black") +
    theme_bw() +     # Customize the plot
    labs(y = "lnVR", x = "") +
    scale_fill_manual(values = c("#73B706", "#06A2BA", "#B90674"))+
    scale_color_manual(values = c("#73B706", "#06A2BA", "#B90674")) +  
    theme(text = element_text(size = 20, color = "black"),
          legend.title = ggplot2::element_text(size = 16),
          legend.text = ggplot2::element_text(size = 14),
          axis.text.y = ggplot2::element_text(size = 10, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
          panel.border = element_rect(color = "black", size = 1.5),
          strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 20)) +
    guides(fill = "none", color = "none")+
    coord_flip()+
    xlim(-0.45, 0.45) +
    facet_wrap(~trait_type, ncol = 3)+
   scale_x_discrete(limits = rev(levels(as.factor(loo_results_lnVR$study_id)))) # Alphabetical order

ggsave(file = "fig/lnVR_LOO.png", width = 12, height = 12, dpi = 500)
``` 

### **Unusual study designs** 

#### *Model specification*
```{r, eval = F}
# Discard observations flagged because the number of generations of selection was unclear, as this would only affect the results of meta-regressions
data <- mutate(data, minor_concerns2 = ifelse(minor_concerns == "gen_selection approximate" | 
                                               minor_concerns == "gen_selection underestimated",
                     NA, minor_concerns))  

# Filter to data without sources of procedural  concerns.
data_concerns <- filter(data, is.na(major_concerns)==T & is.na(minor_concerns2)==T)

# Drop tips that are not in the warm dataset
tips_to_drop <- setdiff(phylo_tree$tip.label, data_concerns$phylogeny)
phylo_tree_concerns <- drop.tip(phylo_tree, tips_to_drop)

# Compute phylogenetic correlation matrix
phylo_matrix_concerns <- vcv(phylo_tree_concerns, cor = T)  # The vcv function returns a variance-covariance matrix

# Convert tibble to data frame
data_concerns <- as.data.frame(data_concerns)

# Calculate VCV matrix
VCV_lnVR_concerns <- vcalc(vi = var_lnVR,
                       cluster = shared_control_ID, 
                       rho = 0.5,
                       obs = obs,
                       data = data_concerns) 

# Model specification
formula <- bf(lnVR ~ 0 + trait_type:warm_cold + trait_type:warm_cold:assay_temp_diff + # Separate effects by trait type
                (trait_type-1|ref) + # Correlation between traits among studies
                (1|species) + # Species-level random effect
                (1|gr(phylogeny, cov = phylo_matrix_concerns)) + # Phylogenetic relatedness
                (1|experiment_ID) + # Experiment-level random effect
                (1|obs) + # Observation-level random effect
                fcor(VCV_lnVR_concerns)) # Variance covariance matix of correlated sampling variances

# Define priors
prior = c(
  prior(constant(1), class = "sigma")
) # Because the residual variance-covariance structure is specified in fcor, there is no need to estimate sigma so it is left as a constant

# Fit model
lnVR_model_concerns <- brm(formula, 
                                      family = gaussian(),
                                      data = data_concerns, 
                                      data2 = list(phylo_matrix_concerns = phylo_matrix_concerns,
                                                   VCV_lnVR_concerns = VCV_lnVR_concerns),
                                      prior = prior,
                                      control = list(adapt_delta = 0.99, max_treedepth = 15),
                                      iter = 4000, 
                                      warmup = 2000,
                                      chains = 4, 
                                      cores = 4, 
                                      seed = 123) 
# Save model
saveRDS(lnVR_model_concerns, file = "RData/lnVR_model_concerns.rds")
```

#### *Model summary*
```{r}
# Load model
lnVR_model_concerns <- readRDS("RData/lnVR_model_concerns.rds")

# Display model output 
summary(lnVR_model_concerns)

# Cleaned model output
as.data.frame(fixef(lnVR_model_concerns, summary = TRUE)) %>%
  # Rename categorical variables for cleaner display
  rownames_to_column(var = "Parameter") %>% 
  mutate(
    Parameter = gsub("trait_type([a-z_]+):warm_cold(cold|warm)", "\\1(\\2)", Parameter),
    Parameter = gsub("trait_type([a-z_]+)\\(warm\\):assay_temp_diff", "\\1(warm): assay_temp_diff", Parameter)
  ) %>%
  # Round numbers to 3 decimal points
  mutate(across(c(Estimate, Q2.5, Q97.5), ~ round(., 3))) %>%
  select(Parameter, Estimate, `Lower CI` = Q2.5, `Upper CI` = Q97.5) %>%
  kable() %>%
  kable_styling(full_width = FALSE, position = "center", fixed_thead = TRUE) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%
  row_spec(0, background = "white", color = "black", bold = TRUE) %>%
  kable_styling(fixed_thead = TRUE)
```

#### *Data visualisation* 
```{r, fig.width = 12, fig.height=10}
# Discard observations flagged because the number of generations of selection was unclear, as this would only affect the results of meta-regressions
data <- mutate(data, minor_concerns2 = ifelse(minor_concerns == "gen_selection approximate" | 
                                               minor_concerns == "gen_selection underestimated",
                     NA, minor_concerns)) 

# Filter to data without sources of procedural  concerns.
data_concerns <- filter(data, is.na(major_concerns)==T & is.na(minor_concerns2)==T)

# Calculate sample sizes and study counts
sample_sizes_concerns <- data_concerns %>%
  group_by(trait_type, warm_cold) %>%
  summarise(
    estimates = n(),
    studies = n_distinct(ref)
  )

# Generate predictions
emmeans_concerns <- as.data.frame(emmeans(
  lnVR_model_concerns,
  specs = ~ assay_temp_diff | trait_type * warm_cold,
  at = list(assay_temp_diff = seq(min(data_concerns$assay_temp_diff), max(data_concerns$assay_temp_diff), by = 0.5))))

# Calculate range of values for each category
range_df_concerns <- data_concerns %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

emmeans_concerns$trait_type <- factor(emmeans_concerns$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_concerns$warm_cold <- factor(emmeans_concerns$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_concerns <- emmeans_concerns %>%
  left_join(range_df_concerns, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data_concerns, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_concerns, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_concerns,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
    geom_text(data = sample_sizes_concerns, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnVR",
       col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5))

ggsave(file = "fig/lnVR_concerns.png", width = 12, height = 7, dpi = 500)
```

# **Figures for publication** 

Note that Figure 1 was created without code.

## **Figure 2**
```{r, fig.width = 12, fig.height = 10}
# Match species to the OTL database
resolved_names <- tnrs_match_names(unique(data$species), context_name = "Animals")

# Create tree
tree <- tol_induced_subtree(ott_ids = resolved_names$ott_id)
tree$tip.label <- strip_ott_ids(tree$tip.label) # Remove ott IDs for presentation

tree <- multi2di(tree, random = TRUE) # Resolve polytomy at random, but it matches classification from Cornetti et al. 2019. Molecular Phylogenetics and Evolution; with D. pulex and D. pulicaria being more closely related to eachother than D. magna
phylo_tree <- compute.brlen(tree, method = "Grafen", power = 1) # Compute branch lengths

# Remove underscore for species names
phylo_tree$tip.label <- gsub("_", " ", phylo_tree$tip.label) # Add underscore between species names

# Create a data summary for each species
species_summary <- data %>%
  group_by(tip.label = species, warm_cold) %>%
  summarise(n_effect_sizes = n(), .groups = "drop") 

species_totals <- species_summary %>%
  group_by(tip.label) %>%
  summarise(total_effect_sizes = sum(n_effect_sizes), .groups = "drop")

# Order species
species_order <- rev(c(
  "Drosophila bipectinata",
  "Drosophila pseudoananassae",
  "Drosophila melanogaster",
  "Drosophila serrata",
  "Drosophila subobscura",
  "Drosophila hydei",
  "Drosophila buzzatii",
  "Musca domestica",
  "Sepsis punctum",
  "Callosobruchus chinensis",
  "Callosobruchus maculatus",
  "Zabrotes subfasciatus",
  "Tribolium castaneum",
  "Daphnia pulicaria",
  "Daphnia pulex",
  "Daphnia magna",
  "Simocephalus vetulus",
  "Apocyclops royi",
  "Eurytemora affinis",
  "Rhizoglyphus robini",
  "Caenorhabditis remanei",
  "Ophryotrocha labronica",
  "Brachionus plicatilis",
  "Poecilia reticulata",
  "Danio rerio"
))

species_summary <- species_summary %>%
  mutate(tip.label = factor(tip.label, levels = species_order))

# Plot tree
tree_plot <- ggtree(phylo_tree, lwd = 1.25) +
  geom_tiplab(size = 5,
              offset = 0.075,
              fontface = "italic") + 
  xlim(0, 2.5) + 
  theme(plot.margin = unit(c(0, 1.5, 0, 0), "cm"))

barplot <- ggplot(species_summary, aes(x = tip.label, 
                                       y = n_effect_sizes, 
                                       fill = warm_cold)) +
  geom_bar(stat = "identity", 
           position = position_dodge2(), 
           width = 0.8) +
  geom_hline(yintercept = 0, 
             color = "black", 
             size = 0.75) +  # Add vertical line
  geom_vline(xintercept = 0.4, 
             color = "black", 
             size = 0.5) +  # Add horizontal line
  geom_text(data = species_totals, 
            aes(x = tip.label, 
                y = -8, 
                label = total_effect_sizes), 
            inherit.aes = FALSE, 
            size = 5) +  # Add total count annotation
  scale_fill_manual(values = c("Cold" = "#06B4BA", "Warm" = "#E80756")) +
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.2))) +  # Add space on the right
  theme_minimal() +
  labs(x = NULL, y = "Number of effect sizes") +
  theme(axis.text.y = element_blank(),  # Remove y-axis text for alignment
        axis.ticks.y = element_blank(),
        panel.grid = element_blank(),  # Remove grid
        plot.background = element_rect(fill = "white", color = NA),  # White background
        legend.position = "none",
        axis.text = element_text (size = 14), col = "black",
        axis.title = element_text(size = 18))


tree_plot | barplot

ggsave(file = "fig/figure_2.png", width = 12, height = 10, dpi = 500)

```

## **Figure 3** 

```{r, fig.width = 12, fig.height=10}
# Load model
lnRR_model_assay_temp_diff <- readRDS("RData/lnRR_model_assay_temp_diff.rds")

# Generate predictions
emmeans_assay_temp_diff <- as.data.frame(emmeans(
  lnRR_model_assay_temp_diff,
  specs = ~ assay_temp_diff | trait_type * warm_cold,
  at = list(assay_temp_diff = seq(min(data$assay_temp_diff), max(data$assay_temp_diff), by = 0.5)))
  )

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

emmeans_assay_temp_diff$trait_type <- factor(emmeans_assay_temp_diff$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_assay_temp_diff$warm_cold <- factor(emmeans_assay_temp_diff$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_assay_temp_diff <- emmeans_assay_temp_diff %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_point(data = data, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_assay_temp_diff, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_assay_temp_diff,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
      geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.9, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnRR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(4, 10))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-1.5, 1.5))

ggsave(file = "fig/figure_3.png", width = 12, height = 10, dpi = 500)
```

## **Figure 4** 

```{r, fig.width = 20, fig.height = 32}
# Load models
lnRR_model_sel_temp_diff <- readRDS("RData/lnRR_model_sel_temp_diff.rds")
lnRR_model_gen_selection <- readRDS("RData/lnRR_model_gen_selection.rds")
lnRR_model_gen_common_garden <- readRDS("RData/lnRR_model_gen_common_garden.rds")
lnRR_model_pop_size <- readRDS("RData/lnRR_model_pop_size.rds")
lnRR_model_all_moderators <- readRDS("RData/lnRR_model_all_moderators.rds")

##################### Selection temperature ################################

# Generate predictions
emmeans_sel_temp_diff <- as.data.frame(emmeans(
  lnRR_model_sel_temp_diff,
  specs = ~ select_temp_diff | trait_type * warm_cold,
  at = list(select_temp_diff = seq(min(data$select_temp_diff), max(data$select_temp_diff), by = 0.1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_select_temp_diff = min(select_temp_diff),
    max_select_temp_diff = max(select_temp_diff)
  )

emmeans_sel_temp_diff$trait_type <- factor(emmeans_sel_temp_diff$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_sel_temp_diff$warm_cold <- factor(emmeans_sel_temp_diff$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_sel_temp_diff <- emmeans_sel_temp_diff %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    select_temp_diff >= min_select_temp_diff,
    select_temp_diff <= max_select_temp_diff
  )

# Plot
sel_temp_diff <- 
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = select_temp_diff, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_sel_temp_diff, # Shaded area for credible intervals
                 aes(x = select_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_sel_temp_diff, # Predicted regression line
               aes(y = emmean,
                   x = select_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.9, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Selection temperature difference", y = "lnRR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(4, 10))+ 
  theme(text = element_text(size = 30, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 28),
        plot.margin = unit(c(1, 0, 0, 0), "cm")) +
    guides(fill = "none", size = "none", color = "none")+
    coord_cartesian(ylim = c(-1.5, 1.5))

############## Generations of selection ##################################

# Generate predictions
emmeans_gen_selection <- as.data.frame(emmeans(
  lnRR_model_gen_selection,
  specs = ~ gen_selection | trait_type * warm_cold,
  at = list(gen_selection = seq(min(data$gen_selection), max(data$gen_selection), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_gen_selection = min(gen_selection),
    max_gen_selection = max(gen_selection)
  )

emmeans_gen_selection$trait_type <- factor(emmeans_gen_selection$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_gen_selection$warm_cold <- factor(emmeans_gen_selection$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_gen_selection <- emmeans_gen_selection %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    gen_selection >= min_gen_selection,
    gen_selection <= max_gen_selection
  )

# Plot
gen_selection <- 
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = gen_selection, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_gen_selection, # Shaded area for credible intervals
                 aes(x = gen_selection,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_gen_selection, # Predicted regression line
               aes(y = emmean,
                   x = gen_selection,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.9, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Number  of generations of selection", y = "lnRR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(4, 10))+ 
  theme(text = element_text(size = 30, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 28),
        plot.margin = unit(c(1.5, 0, 0, 0), "cm")) +
    guides(fill = "none", size = "none", color = "none")+
    coord_cartesian(ylim = c(-1.5, 1.5),
                    xlim = c(0, 150))


################### Generations of common garden #################################

# Generate predictions
emmeans_gen_common_garden <- as.data.frame(emmeans(
  lnRR_model_gen_common_garden,
  specs = ~ gen_common_garden | trait_type * warm_cold,
  at = list(gen_common_garden = seq(min(data$gen_common_garden), max(data$gen_common_garden), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_gen_common_garden = min(gen_common_garden),
    max_gen_common_garden = max(gen_common_garden)
  )

emmeans_gen_common_garden$trait_type <- factor(emmeans_gen_common_garden$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_gen_common_garden$warm_cold <- factor(emmeans_gen_common_garden$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_gen_common_garden <- emmeans_gen_common_garden %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    gen_common_garden >= min_gen_common_garden,
    gen_common_garden <= max_gen_common_garden
  )

# Plot
gen_common_garden <- 
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = gen_common_garden, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_gen_common_garden, # Shaded area for credible intervals
                 aes(x = gen_common_garden,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_gen_common_garden, # Predicted regression line
               aes(y = emmean,
                   x = gen_common_garden,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.9, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Number of generations of common garden", y = "", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(4, 10))+ 
  theme(text = element_text(size = 30, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 28),
        plot.margin = unit(c(1.5, 1, 0, 0.5), "cm")) +
    guides(fill = "none", size = "none", color = "none")+
    coord_cartesian(ylim = c(-1.5, 1.5),
                    xlim = c(0, 11.5))

##################### Initial population size ##################################

# Generate predictions
emmeans_pop_size <- as.data.frame(emmeans(
  lnRR_model_pop_size,
  specs = ~ pop_size | trait_type * warm_cold,
  at = list(pop_size = seq(min(data$pop_size, na.rm=T), max(data$pop_size, na.rm=T), by = 50),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_pop_size = min(pop_size, na.rm=T),
    max_pop_size = max(pop_size, na.rm=T)
  )

emmeans_pop_size$trait_type <- factor(emmeans_pop_size$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_pop_size$warm_cold <- factor(emmeans_pop_size$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_pop_size <- emmeans_pop_size %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    pop_size >= min_pop_size,
    pop_size <= max_pop_size
  )

# Calculate sample sizes and study counts for population size
sample_sizes_pop_size <- data %>%
  filter(is.na(pop_size)==FALSE) %>% 
  group_by(trait_type, warm_cold) %>%
  summarise(
    estimates = n(),
    studies = n_distinct(ref)
  )

# Plot
pop_size <- 
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = pop_size, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_pop_size, # Shaded area for credible intervals
                 aes(x = pop_size,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_pop_size, # Predicted regression line
               aes(y = emmean,
                   x = pop_size,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes_pop_size, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -0.9, -1.3),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Population size", y = "", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(4, 10))+ 
  theme(text = element_text(size = 30, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 28),
        plot.margin = unit(c(0, 1, 0, 0.5), "cm")) +
    guides(fill = "none", size = "none", color = "none")+
    coord_cartesian(ylim = c(-1.5, 1.5))

##################### Full model ##################################

# Generate predictions at the mean of each moderator
emmeans_full_model <- as.data.frame(emmeans(
  lnRR_model_all_moderators,
  specs = ~ assay_temp_diff * select_temp_diff * gen_selection * gen_common_garden | trait_type * warm_cold,
   at = list(assay_temp_diff = seq(min(data$assay_temp_diff), max(data$assay_temp_diff), by = 0.5)))) 


# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

emmeans_full_model$trait_type <- factor(emmeans_full_model$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_full_model$warm_cold <- factor(emmeans_full_model$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_full_model <- emmeans_full_model%>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )

# Plot
assay_temp <-
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnRR, 
                      size = 1/sqrt(var_lnRR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_full_model, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_full_model,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
    geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnRR",
       col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(4, 10))+ 
  theme(text = element_text(size = 30, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 28)) +
    guides(fill = "none", size = "none", col = "none")+
    coord_cartesian(ylim = c(-1.5, 1.5))


assay_temp / (sel_temp_diff | pop_size) / (gen_selection | gen_common_garden)

ggsave(file = "fig/figure_4.png", width = 20, height = 32, dpi = 500)
```


## **Figure 5** 

```{r, fig.width = 12, fig.height=10}
# Load model
lnVR_model_assay_temp_diff <- readRDS("RData/lnVR_model_assay_temp_diff.rds")

# Generate predictions
emmeans_assay_temp_diff <- as.data.frame(emmeans(
  lnVR_model_assay_temp_diff,
  specs = ~ assay_temp_diff | trait_type * warm_cold,
  at = list(assay_temp_diff = seq(min(data$assay_temp_diff), max(data$assay_temp_diff), by = 0.5)))
  )

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

emmeans_assay_temp_diff$trait_type <- factor(emmeans_assay_temp_diff$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_assay_temp_diff$warm_cold <- factor(emmeans_assay_temp_diff$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_assay_temp_diff <- emmeans_assay_temp_diff %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_assay_temp_diff, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_assay_temp_diff,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
    geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnVR",
       col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 25, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 22)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5))

ggsave(file = "fig/figure_5.png", width = 12, height = 10, dpi = 500)
```

## **Figure 6**

```{r, fig.width = 20, fig.height = 32}
# Load models
lnVR_model_sel_temp_diff <- readRDS("RData/lnVR_model_sel_temp_diff.rds")
lnVR_model_gen_selection <- readRDS("RData/lnVR_model_gen_selection.rds")
lnVR_model_gen_common_garden <- readRDS("RData/lnVR_model_gen_common_garden.rds")
lnVR_model_pop_size <- readRDS("RData/lnVR_model_pop_size.rds")
lnVR_model_all_moderators <- readRDS("RData/lnVR_model_all_moderators.rds")

##################### Selection temperature ################################

# Generate predictions
emmeans_sel_temp_diff <- as.data.frame(emmeans(
  lnVR_model_sel_temp_diff,
  specs = ~ select_temp_diff | trait_type * warm_cold,
  at = list(select_temp_diff = seq(min(data$select_temp_diff), max(data$select_temp_diff), by = 0.1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_select_temp_diff = min(select_temp_diff),
    max_select_temp_diff = max(select_temp_diff)
  )

emmeans_sel_temp_diff$trait_type <- factor(emmeans_sel_temp_diff$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_sel_temp_diff$warm_cold <- factor(emmeans_sel_temp_diff$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_sel_temp_diff <- emmeans_sel_temp_diff %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    select_temp_diff >= min_select_temp_diff,
    select_temp_diff <= max_select_temp_diff
  )

# Plot
sel_temp_diff <- 
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = select_temp_diff, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_sel_temp_diff, # Shaded area for credible intervals
                 aes(x = select_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_sel_temp_diff, # Predicted regression line
               aes(y = emmean,
                   x = select_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Selection temperature difference", y = "lnVR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
 theme(text = element_text(size = 30, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 28),
        plot.margin = unit(c(1, 0, 0, 0), "cm")) +
    guides(fill = "none", size = "none", color = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5))

############## Generations of selection ##################################

# Generate predictions
emmeans_gen_selection <- as.data.frame(emmeans(
  lnVR_model_gen_selection,
  specs = ~ gen_selection | trait_type * warm_cold,
  at = list(gen_selection = seq(min(data$gen_selection), max(data$gen_selection), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_gen_selection = min(gen_selection),
    max_gen_selection = max(gen_selection)
  )

emmeans_gen_selection$trait_type <- factor(emmeans_gen_selection$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_gen_selection$warm_cold <- factor(emmeans_gen_selection$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_gen_selection <- emmeans_gen_selection %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    gen_selection >= min_gen_selection,
    gen_selection <= max_gen_selection
  )

# Plot
gen_selection <- 
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = gen_selection, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_gen_selection, # Shaded area for credible intervals
                 aes(x = gen_selection,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_gen_selection, # Predicted regression line
               aes(y = emmean,
                   x = gen_selection,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Number  of generations of selection", y = "lnRR", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 30, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 28),
        plot.margin = unit(c(1.5, 0, 0, 0), "cm")) +
    guides(fill = "none", size = "none", color = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5),
                    xlim = c(0, 150))

################### Generations of common garden #################################

# Generate predictions
emmeans_gen_common_garden <- as.data.frame(emmeans(
  lnVR_model_gen_common_garden,
  specs = ~ gen_common_garden | trait_type * warm_cold,
  at = list(gen_common_garden = seq(min(data$gen_common_garden), max(data$gen_common_garden), by = 1),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_gen_common_garden = min(gen_common_garden),
    max_gen_common_garden = max(gen_common_garden)
  )

emmeans_gen_common_garden$trait_type <- factor(emmeans_gen_common_garden$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_gen_common_garden$warm_cold <- factor(emmeans_gen_common_garden$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_gen_common_garden <- emmeans_gen_common_garden %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    gen_common_garden >= min_gen_common_garden,
    gen_common_garden <= max_gen_common_garden
  )

# Plot
gen_common_garden <- 
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = gen_common_garden, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_gen_common_garden, # Shaded area for credible intervals
                 aes(x = gen_common_garden,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_gen_common_garden, # Predicted regression line
               aes(y = emmean,
                   x = gen_common_garden,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Number of generations of common garden", y = "", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 30, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 28),
        plot.margin = unit(c(1.5, 1, 0, 0.5), "cm")) +
    guides(fill = "none", size = "none", color = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5),
                    xlim = c(0, 11.5))

##################### Initial population size ##################################

# Generate predictions
emmeans_pop_size <- as.data.frame(emmeans(
  lnVR_model_pop_size,
  specs = ~ pop_size | trait_type * warm_cold,
  at = list(pop_size = seq(min(data$pop_size, na.rm=T), max(data$pop_size, na.rm=T), by = 50),
            assay_temp_diff = 0))
  ) # Conditional effects on assay_temp_diff = 0

# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_pop_size = min(pop_size, na.rm=T),
    max_pop_size = max(pop_size, na.rm=T)
  )

emmeans_pop_size$trait_type <- factor(emmeans_pop_size$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_pop_size$warm_cold <- factor(emmeans_pop_size$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_pop_size <- emmeans_pop_size %>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    pop_size >= min_pop_size,
    pop_size <= max_pop_size
  )

# Calculate sample sizes and study counts for population size
sample_sizes_pop_size <- data %>%
  filter(is.na(pop_size)==FALSE) %>% 
  group_by(trait_type, warm_cold) %>%
  summarise(
    estimates = n(),
    studies = n_distinct(ref)
  )

# Plot
pop_size <- 
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data,  # Effect sizes, scaled by precision
                  aes(x = pop_size, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_pop_size, # Shaded area for credible intervals
                 aes(x = pop_size,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_pop_size, # Predicted regression line
               aes(y = emmean,
                   x = pop_size,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) +  
     geom_text(data = sample_sizes_pop_size, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  facet_wrap(~ trait_type, ncol = 1) +  # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Population size", y = "", col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 30, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 28),
        plot.margin = unit(c(0, 1, 0, 0.5), "cm")) +
    guides(fill = "none", size = "none", color = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5))

##################### Full model  ##################################

# Generate predictions at the mean of each moderator
emmeans_full_model <- as.data.frame(emmeans(
  lnVR_model_all_moderators,
  specs = ~ assay_temp_diff * select_temp_diff * gen_selection * gen_common_garden | trait_type * warm_cold,
   at = list(assay_temp_diff = seq(min(data$assay_temp_diff), max(data$assay_temp_diff), by = 0.5)))) 


# Calculate range of values for each category
range_df <- data %>%
  group_by(trait_type, warm_cold) %>%
  summarize(
    min_assay_temp_diff = min(assay_temp_diff),
    max_assay_temp_diff = max(assay_temp_diff)
  )

emmeans_full_model$trait_type <- factor(emmeans_full_model$trait_type, 
                          levels = c("body_size", "fecundity", "survival"), 
                          labels = c("Body size", "Fecundity", "Survival"))

emmeans_full_model$warm_cold <- factor(emmeans_full_model$warm_cold, 
                          levels = c("cold", "warm"), 
                          labels = c("Cold", "Warm"))

# Tailor predictions to the range of the data
emmeans_full_model <- emmeans_full_model%>%
  left_join(range_df, by = c("trait_type", "warm_cold")) %>%
  filter(
    assay_temp_diff >= min_assay_temp_diff,
    assay_temp_diff <= max_assay_temp_diff
  )

# Plot
ggplot() + 
    geom_hline(yintercept = 0, # Horizontal line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) +  
    geom_vline(xintercept = 0, # Vertical line
               linetype = 2, 
               colour = "black", 
               alpha = 0.75) + 
    geom_point(data = data, # Effect sizes, scaled by precision
                  aes(x = assay_temp_diff, 
                      y = lnVR, 
                      size = 1/sqrt(var_lnVR), 
                      fill = warm_cold), 
                  shape = 21, 
                  alpha = 0.7, 
                  stroke = 1,
                  position = position_jitter(width = 0.05)) + 
     geom_ribbon(data = emmeans_full_model, # Shaded area for credible intervals
                 aes(x = assay_temp_diff,
                     ymin = lower.HPD, 
                     ymax = upper.HPD, 
                     fill = warm_cold,
                     group = warm_cold), 
                 alpha = .5) + 
     geom_line(data = emmeans_full_model,  # Predicted regression line
               aes(y = emmean,
                   x = assay_temp_diff,
                   color = warm_cold,
                   group = warm_cold), 
               size = 1.5) + 
    geom_text(data = sample_sizes, 
              aes(x = Inf, 
                  y = ifelse(warm_cold == "Warm", -2, -2.75),  # Sample sizes
                  label = paste0("k = ", estimates, " (", studies, ")"),
                  color = warm_cold), 
              hjust = 1.05, size = 5, show.legend = FALSE) +
  
  facet_wrap(~ trait_type, ncol = 1) + # Different panels for each trait
  scale_fill_manual(values = c("#06B4BA", "#E80756"))+
  scale_color_manual(values = c("#06B4BA", "#E80756"))+
  labs(x = "Assay temperature difference", y = "lnVR",
       col = "Regime") +
  theme_bw() + 
  scale_size_continuous(range = c(2, 8))+ 
  theme(text = element_text(size = 30, color = "black"),
          legend.title = ggplot2::element_text(size = 18),
          legend.text = ggplot2::element_text(size = 16),
          axis.text.y = ggplot2::element_text(size = 20, 
                colour = "black", hjust = 0.5),
          axis.text.x = ggplot2::element_text(size = 20),
        panel.border = element_rect(color = "black", size = 1.5),
        strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 28)) +
    guides(fill = "none", size = "none")+
    coord_cartesian(ylim = c(-3.5, 3.5))

assay_temp / (sel_temp_diff | pop_size) / (gen_selection | gen_common_garden)

ggsave(file = "fig/figure_6.png", width = 20, height = 32, dpi = 500)
```

## **Figure S1**

# **Package information** 

```{r}
sessionInfo()
```

